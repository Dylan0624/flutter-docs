# Flutter 專案設計與架構管理完全指南

## 🏗️ 專案架構概覽

### 為什麼需要好的專案架構？

一個好的專案架構能夠：

- 🎯 **提高開發效率**：清晰的結構讓功能開發更快速
- 🔧 **便於維護**：易於理解和修改現有功能
- 👥 **團隊協作**：統一的架構規範讓多人協作更順暢
- 🚀 **可擴展性**：隨著專案成長能夠輕鬆添加新功能
- 🧪 **可測試性**：清晰的分層讓單元測試更容易編寫

### 架構設計原則

1. **單一職責原則**：每個類別或模組只負責一個功能
2. **開放封閉原則**：對擴展開放，對修改封閉
3. **依賴倒置原則**：高層模組不依賴低層模組
4. **關注點分離**：UI、業務邏輯、資料層分離
5. **可測試性**：架構設計要便於單元測試

------

## 📁 專案目錄結構設計

### 完整的專案目錄架構

```
my_flutter_app/
├── android/                    # Android 平台特定檔案
├── ios/                        # iOS 平台特定檔案
├── web/                        # Web 平台特定檔案
├── assets/                     # 資源檔案
│   ├── images/                 # 圖片資源
│   │   ├── icons/             # 圖標
│   │   ├── backgrounds/       # 背景圖
│   │   └── logos/             # 標誌圖片
│   ├── fonts/                 # 字型檔案
│   ├── data/                  # 靜態資料檔案
│   │   ├── json/              # JSON 資料
│   │   └── translations/      # 多語言檔案
│   └── animations/            # 動畫檔案
│       ├── lottie/           # Lottie 動畫
│       └── rive/             # Rive 動畫
├── lib/                       # 主要程式碼目錄 🔥
│   ├── main.dart             # 應用程式入口
│   ├── app.dart              # 主應用程式 Widget
│   ├── core/                 # 核心功能模組
│   │   ├── constants/        # 常數定義
│   │   │   ├── app_constants.dart      # 應用程式常數
│   │   │   ├── api_constants.dart      # API 相關常數
│   │   │   ├── storage_constants.dart  # 儲存相關常數
│   │   │   └── route_constants.dart    # 路由常數
│   │   ├── config/           # 配置管理
│   │   │   ├── app_config.dart         # 應用程式配置
│   │   │   ├── environment_config.dart # 環境配置
│   │   │   └── theme_config.dart       # 主題配置
│   │   ├── errors/           # 錯誤處理
│   │   │   ├── app_error.dart          # 應用程式錯誤定義
│   │   │   ├── error_handler.dart      # 錯誤處理器
│   │   │   └── exceptions.dart         # 自訂例外
│   │   ├── network/          # 網路層
│   │   │   ├── api_client.dart         # API 客戶端
│   │   │   ├── interceptors.dart       # 請求攔截器
│   │   │   ├── network_info.dart       # 網路狀態檢查
│   │   │   └── response_wrapper.dart   # 響應包裝器
│   │   ├── storage/          # 本地儲存
│   │   │   ├── local_storage.dart      # 本地儲存介面
│   │   │   ├── shared_prefs_storage.dart # SharedPreferences 實作
│   │   │   ├── secure_storage.dart     # 安全儲存
│   │   │   └── database/               # 資料庫相關
│   │   │       ├── app_database.dart   # 資料庫定義
│   │   │       ├── dao/                # 資料存取物件
│   │   │       └── entities/           # 資料庫實體
│   │   ├── utils/            # 工具類別
│   │   │   ├── date_utils.dart         # 日期工具
│   │   │   ├── validation_utils.dart   # 驗證工具
│   │   │   ├── format_utils.dart       # 格式化工具
│   │   │   ├── permission_utils.dart   # 權限工具
│   │   │   └── image_utils.dart        # 圖片處理工具
│   │   ├── extensions/       # 擴展方法
│   │   │   ├── string_extensions.dart  # 字串擴展
│   │   │   ├── date_extensions.dart    # 日期擴展
│   │   │   ├── context_extensions.dart # BuildContext 擴展
│   │   │   └── widget_extensions.dart  # Widget 擴展
│   │   └── injection/        # 依賴注入
│   │       ├── injection.dart          # 依賴注入配置
│   │       └── injection.config.dart   # 生成的配置檔案
│   ├── data/                 # 資料層 (Repository Pattern)
│   │   ├── repositories/     # 儲存庫實作
│   │   │   ├── auth_repository_impl.dart
│   │   │   ├── user_repository_impl.dart
│   │   │   └── product_repository_impl.dart
│   │   ├── datasources/      # 資料源
│   │   │   ├── remote/       # 遠端資料源
│   │   │   │   ├── auth_remote_datasource.dart
│   │   │   │   ├── user_remote_datasource.dart
│   │   │   │   └── product_remote_datasource.dart
│   │   │   └── local/        # 本地資料源
│   │   │       ├── auth_local_datasource.dart
│   │   │       ├── user_local_datasource.dart
│   │   │       └── product_local_datasource.dart
│   │   └── models/           # 資料模型 (DTO)
│   │       ├── request/      # 請求模型
│   │       │   ├── login_request.dart
│   │       │   └── register_request.dart
│   │       ├── response/     # 響應模型
│   │       │   ├── login_response.dart
│   │       │   ├── user_response.dart
│   │       │   └── product_response.dart
│   │       └── local/        # 本地模型
│   │           ├── user_local_model.dart
│   │           └── product_local_model.dart
│   ├── domain/               # 業務邏輯層
│   │   ├── entities/         # 業務實體
│   │   │   ├── user.dart
│   │   │   ├── product.dart
│   │   │   ├── order.dart
│   │   │   └── auth_token.dart
│   │   ├── repositories/     # 儲存庫抽象介面
│   │   │   ├── auth_repository.dart
│   │   │   ├── user_repository.dart
│   │   │   └── product_repository.dart
│   │   └── usecases/         # 用例 (業務邏輯)
│   │       ├── auth/         # 認證相關用例
│   │       │   ├── login_usecase.dart
│   │       │   ├── logout_usecase.dart
│   │       │   ├── register_usecase.dart
│   │       │   └── refresh_token_usecase.dart
│   │       ├── user/         # 使用者相關用例
│   │       │   ├── get_user_profile_usecase.dart
│   │       │   ├── update_user_profile_usecase.dart
│   │       │   └── delete_user_account_usecase.dart
│   │       └── product/      # 產品相關用例
│   │           ├── get_products_usecase.dart
│   │           ├── search_products_usecase.dart
│   │           └── get_product_detail_usecase.dart
│   ├── presentation/         # 表現層 (UI)
│   │   ├── pages/            # 頁面
│   │   │   ├── auth/         # 認證頁面
│   │   │   │   ├── login_page.dart
│   │   │   │   ├── register_page.dart
│   │   │   │   └── forgot_password_page.dart
│   │   │   ├── home/         # 首頁相關
│   │   │   │   ├── home_page.dart
│   │   │   │   └── dashboard_page.dart
│   │   │   ├── profile/      # 個人資料頁面
│   │   │   │   ├── profile_page.dart
│   │   │   │   ├── edit_profile_page.dart
│   │   │   │   └── settings_page.dart
│   │   │   ├── product/      # 產品頁面
│   │   │   │   ├── product_list_page.dart
│   │   │   │   ├── product_detail_page.dart
│   │   │   │   └── product_search_page.dart
│   │   │   └── common/       # 通用頁面
│   │   │       ├── splash_page.dart
│   │   │       ├── onboarding_page.dart
│   │   │       ├── error_page.dart
│   │   │       └── no_internet_page.dart
│   │   ├── widgets/          # 可重用 Widget
│   │   │   ├── common/       # 通用 Widget
│   │   │   │   ├── app_button.dart
│   │   │   │   ├── app_text_field.dart
│   │   │   │   ├── app_card.dart
│   │   │   │   ├── app_loading.dart
│   │   │   │   ├── app_error.dart
│   │   │   │   ├── app_empty_state.dart
│   │   │   │   └── app_image.dart
│   │   │   ├── forms/        # 表單相關 Widget
│   │   │   │   ├── login_form.dart
│   │   │   │   ├── register_form.dart
│   │   │   │   └── profile_form.dart
│   │   │   ├── lists/        # 列表相關 Widget
│   │   │   │   ├── product_list_item.dart
│   │   │   │   ├── user_list_item.dart
│   │   │   │   └── infinite_scroll_list.dart
│   │   │   └── dialogs/      # 對話框 Widget
│   │   │       ├── confirmation_dialog.dart
│   │   │       ├── loading_dialog.dart
│   │   │       └── info_dialog.dart
│   │   ├── providers/        # 狀態管理 (使用 Provider)
│   │   │   ├── auth_provider.dart
│   │   │   ├── user_provider.dart
│   │   │   ├── product_provider.dart
│   │   │   └── theme_provider.dart
│   │   ├── blocs/            # 狀態管理 (使用 Bloc，可選)
│   │   │   ├── auth/
│   │   │   │   ├── auth_bloc.dart
│   │   │   │   ├── auth_event.dart
│   │   │   │   └── auth_state.dart
│   │   │   └── product/
│   │   │       ├── product_bloc.dart
│   │   │       ├── product_event.dart
│   │   │       └── product_state.dart
│   │   └── routes/           # 路由管理
│   │       ├── app_router.dart          # 主路由配置
│   │       ├── route_names.dart         # 路由名稱常數
│   │       └── route_guards.dart        # 路由守衛
│   └── l10n/                 # 國際化
│       ├── app_localizations.dart      # 本地化主檔案
│       ├── app_localizations_en.dart   # 英文
│       ├── app_localizations_zh.dart   # 中文
│       └── l10n.yaml                   # 配置檔案
├── test/                     # 測試檔案
│   ├── unit/                 # 單元測試
│   │   ├── domain/
│   │   │   └── usecases/
│   │   ├── data/
│   │   │   └── repositories/
│   │   └── presentation/
│   │       └── providers/
│   ├── widget/               # Widget 測試
│   │   ├── pages/
│   │   └── widgets/
│   ├── integration/          # 整合測試
│   └── helpers/              # 測試輔助工具
│       ├── test_helper.dart
│       └── mock_data.dart
├── tool/                     # 開發工具
│   ├── build_runner.dart     # 程式碼生成工具
│   ├── env_generator.dart    # 環境檔案生成器
│   └── icon_generator.dart   # 圖標生成器
├── docs/                     # 專案文檔
│   ├── README.md
│   ├── CHANGELOG.md
│   ├── API.md
│   └── DEPLOYMENT.md
├── scripts/                  # 建置腳本
│   ├── build_android.sh
│   ├── build_ios.sh
│   └── deploy.sh
├── .github/                  # GitHub 工作流程
│   └── workflows/
│       ├── ci.yml
│       └── cd.yml
├── pubspec.yaml             # 套件依賴配置
├── pubspec.lock             # 鎖定的套件版本
├── analysis_options.yaml    # 程式碼分析配置
├── .gitignore              # Git 忽略檔案
├── .env.example            # 環境變數範例
├── .metadata               # Flutter 專案元資料
└── README.md               # 專案說明
```

------

## 🏛️ MVVM 架構模式實作

### MVVM 架構層次

```dart
// 📊 Model Layer (資料層)
// 位置: lib/data/ 和 lib/domain/

// 1. Entity (業務實體) - domain/entities/
class User {
  final String id;
  final String name;
  final String email;
  final DateTime? lastLoginAt;
  final UserStatus status;
  
  const User({
    required this.id,
    required this.name,
    required this.email,
    this.lastLoginAt,
    required this.status,
  });
  
  // 業務邏輯方法
  bool get isActive => status == UserStatus.active;
  bool get isNewUser => lastLoginAt == null;
  
  String get displayName => name.isNotEmpty ? name : email.split('@').first;
  
  // 複製方法 (用於不可變物件)
  User copyWith({
    String? id,
    String? name,
    String? email,
    DateTime? lastLoginAt,
    UserStatus? status,
  }) {
    return User(
      id: id ?? this.id,
      name: name ?? this.name,
      email: email ?? this.email,
      lastLoginAt: lastLoginAt ?? this.lastLoginAt,
      status: status ?? this.status,
    );
  }
  
  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is User && runtimeType == other.runtimeType && id == other.id;
  
  @override
  int get hashCode => id.hashCode;
}

enum UserStatus { active, inactive, banned, pending }

// 2. Data Model (資料傳輸物件) - data/models/
class UserResponse {
  final String id;
  final String name;
  final String email;
  final String? lastLoginAt;
  final String status;
  
  UserResponse({
    required this.id,
    required this.name,
    required this.email,
    this.lastLoginAt,
    required this.status,
  });
  
  // JSON 序列化
  factory UserResponse.fromJson(Map<String, dynamic> json) {
    return UserResponse(
      id: json['id'] as String,
      name: json['name'] as String,
      email: json['email'] as String,
      lastLoginAt: json['last_login_at'] as String?,
      status: json['status'] as String,
    );
  }
  
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'email': email,
      'last_login_at': lastLoginAt,
      'status': status,
    };
  }
  
  // 轉換為業務實體
  User toEntity() {
    return User(
      id: id,
      name: name,
      email: email,
      lastLoginAt: lastLoginAt != null 
          ? DateTime.tryParse(lastLoginAt!) 
          : null,
      status: _parseStatus(status),
    );
  }
  
  UserStatus _parseStatus(String status) {
    switch (status.toLowerCase()) {
      case 'active':
        return UserStatus.active;
      case 'inactive':
        return UserStatus.inactive;
      case 'banned':
        return UserStatus.banned;
      case 'pending':
        return UserStatus.pending;
      default:
        return UserStatus.inactive;
    }
  }
}

// 3. Repository Interface (抽象儲存庫) - domain/repositories/
abstract class UserRepository {
  Future<User?> getUserById(String id);
  Future<List<User>> getUsers({int page = 1, int limit = 20});
  Future<User> createUser(User user);
  Future<User> updateUser(User user);
  Future<void> deleteUser(String id);
  Future<List<User>> searchUsers(String query);
  Stream<User> getUserStream(String id);
}

// 4. Repository Implementation (儲存庫實作) - data/repositories/
class UserRepositoryImpl implements UserRepository {
  final UserRemoteDataSource _remoteDataSource;
  final UserLocalDataSource _localDataSource;
  final NetworkInfo _networkInfo;
  
  UserRepositoryImpl({
    required UserRemoteDataSource remoteDataSource,
    required UserLocalDataSource localDataSource,
    required NetworkInfo networkInfo,
  }) : _remoteDataSource = remoteDataSource,
       _localDataSource = localDataSource,
       _networkInfo = networkInfo;
  
  @override
  Future<User?> getUserById(String id) async {
    try {
      // 先從本地快取取得
      final localUser = await _localDataSource.getUserById(id);
      
      if (await _networkInfo.isConnected) {
        // 有網路時從遠端更新
        final remoteUser = await _remoteDataSource.getUserById(id);
        if (remoteUser != null) {
          // 更新本地快取
          await _localDataSource.cacheUser(remoteUser);
          return remoteUser.toEntity();
        }
      }
      
      return localUser?.toEntity();
    } catch (error) {
      throw UserException('無法取得使用者資料: $error');
    }
  }
  
  @override
  Future<List<User>> getUsers({int page = 1, int limit = 20}) async {
    try {
      if (await _networkInfo.isConnected) {
        final remoteUsers = await _remoteDataSource.getUsers(
          page: page,
          limit: limit,
        );
        
        // 快取資料
        await _localDataSource.cacheUsers(remoteUsers);
        
        return remoteUsers.map((user) => user.toEntity()).toList();
      } else {
        // 離線時從本地取得
        final localUsers = await _localDataSource.getCachedUsers(
          page: page,
          limit: limit,
        );
        return localUsers.map((user) => user.toEntity()).toList();
      }
    } catch (error) {
      throw UserException('無法取得使用者列表: $error');
    }
  }
  
  @override
  Future<User> createUser(User user) async {
    try {
      if (!await _networkInfo.isConnected) {
        throw NetworkException('建立使用者需要網路連線');
      }
      
      final userResponse = UserResponse(
        id: user.id,
        name: user.name,
        email: user.email,
        lastLoginAt: user.lastLoginAt?.toIso8601String(),
        status: user.status.toString().split('.').last,
      );
      
      final createdUser = await _remoteDataSource.createUser(userResponse);
      
      // 快取新建立的使用者
      await _localDataSource.cacheUser(createdUser);
      
      return createdUser.toEntity();
    } catch (error) {
      throw UserException('建立使用者失敗: $error');
    }
  }
  
  // 其他方法實作...
}
```

### ViewModel Layer (表現邏輯層)

```dart
// 📱 ViewModel (使用 ChangeNotifier)
// 位置: lib/presentation/providers/

class UserViewModel extends ChangeNotifier {
  final GetUserProfileUseCase _getUserProfileUseCase;
  final UpdateUserProfileUseCase _updateUserProfileUseCase;
  final DeleteUserAccountUseCase _deleteUserAccountUseCase;
  
  UserViewModel({
    required GetUserProfileUseCase getUserProfileUseCase,
    required UpdateUserProfileUseCase updateUserProfileUseCase,
    required DeleteUserAccountUseCase deleteUserAccountUseCase,
  }) : _getUserProfileUseCase = getUserProfileUseCase,
       _updateUserProfileUseCase = updateUserProfileUseCase,
       _deleteUserAccountUseCase = deleteUserAccountUseCase;
  
  // 狀態變數
  User? _user;
  bool _isLoading = false;
  String? _errorMessage;
  bool _isUpdating = false;
  
  // Getters (暴露給 View)
  User? get user => _user;
  bool get isLoading => _isLoading;
  String? get errorMessage => _errorMessage;
  bool get isUpdating => _isUpdating;
  bool get hasUser => _user != null;
  
  // 業務邏輯方法
  Future<void> loadUserProfile(String userId) async {
    _setLoading(true);
    _clearError();
    
    try {
      final result = await _getUserProfileUseCase.execute(userId);
      result.fold(
        (failure) => _setError(failure.message),
        (user) => _setUser(user),
      );
    } catch (error) {
      _setError('載入使用者資料失敗: $error');
    } finally {
      _setLoading(false);
    }
  }
  
  Future<void> updateProfile({
    required String name,
    required String email,
  }) async {
    if (_user == null) return;
    
    _setUpdating(true);
    _clearError();
    
    try {
      final updatedUser = _user!.copyWith(name: name, email: email);
      final result = await _updateUserProfileUseCase.execute(updatedUser);
      
      result.fold(
        (failure) => _setError(failure.message),
        (user) {
          _setUser(user);
          _showSuccessMessage('個人資料更新成功');
        },
      );
    } catch (error) {
      _setError('更新個人資料失敗: $error');
    } finally {
      _setUpdating(false);
    }
  }
  
  Future<bool> deleteAccount() async {
    if (_user == null) return false;
    
    _setLoading(true);
    _clearError();
    
    try {
      final result = await _deleteUserAccountUseCase.execute(_user!.id);
      return result.fold(
        (failure) {
          _setError(failure.message);
          return false;
        },
        (_) {
          _clearUser();
          return true;
        },
      );
    } catch (error) {
      _setError('刪除帳號失敗: $error');
      return false;
    } finally {
      _setLoading(false);
    }
  }
  
  // 重新載入資料
  Future<void> refresh() async {
    if (_user != null) {
      await loadUserProfile(_user!.id);
    }
  }
  
  // 清除錯誤訊息
  void clearError() {
    _clearError();
  }
  
  // 私有方法 (狀態管理)
  void _setUser(User user) {
    _user = user;
    notifyListeners();
  }
  
  void _clearUser() {
    _user = null;
    notifyListeners();
  }
  
  void _setLoading(bool loading) {
    _isLoading = loading;
    notifyListeners();
  }
  
  void _setUpdating(bool updating) {
    _isUpdating = updating;
    notifyListeners();
  }
  
  void _setError(String error) {
    _errorMessage = error;
    notifyListeners();
  }
  
  void _clearError() {
    _errorMessage = null;
    notifyListeners();
  }
  
  void _showSuccessMessage(String message) {
    // 可以通過事件系統或其他方式通知 UI 顯示成功訊息
    // 這裡可以使用 EventBus 或其他通知機制
  }
  
  @override
  void dispose() {
    // 清理資源
    super.dispose();
  }
}

// 使用 Riverpod 的 ViewModel 實作 (可選)
class UserNotifier extends StateNotifier<UserState> {
  final GetUserProfileUseCase _getUserProfileUseCase;
  final UpdateUserProfileUseCase _updateUserProfileUseCase;
  
  UserNotifier({
    required GetUserProfileUseCase getUserProfileUseCase,
    required UpdateUserProfileUseCase updateUserProfileUseCase,
  }) : _getUserProfileUseCase = getUserProfileUseCase,
       _updateUserProfileUseCase = updateUserProfileUseCase,
       super(const UserState.initial());
  
  Future<void> loadUser(String userId) async {
    state = const UserState.loading();
    
    final result = await _getUserProfileUseCase.execute(userId);
    state = result.fold(
      (failure) => UserState.error(failure.message),
      (user) => UserState.loaded(user),
    );
  }
  
  Future<void> updateUser(User user) async {
    state = state.copyWith(isUpdating: true);
    
    final result = await _updateUserProfileUseCase.execute(user);
    state = result.fold(
      (failure) => state.copyWith(
        isUpdating: false,
        errorMessage: failure.message,
      ),
      (updatedUser) => UserState.loaded(updatedUser),
    );
  }
}

// 狀態類別 (用於 Riverpod)
@freezed
class UserState with _$UserState {
  const factory UserState.initial() = _Initial;
  const factory UserState.loading() = _Loading;
  const factory UserState.loaded(User user) = _Loaded;
  const factory UserState.error(String message) = _Error;
  
  const factory UserState.custom({
    User? user,
    @Default(false) bool isLoading,
    @Default(false) bool isUpdating,
    String? errorMessage,
  }) = _Custom;
}
```

### View Layer (表現層)

```dart
// 🖼️ View (UI 層)
// 位置: lib/presentation/pages/

class UserProfilePage extends StatefulWidget {
  final String userId;
  
  const UserProfilePage({
    Key? key,
    required this.userId,
  }) : super(key: key);
  
  @override
  State<UserProfilePage> createState() => _UserProfilePageState();
}

class _UserProfilePageState extends State<UserProfilePage> {
  late UserViewModel _viewModel;
  
  @override
  void initState() {
    super.initState();
    // 從依賴注入容器取得 ViewModel
    _viewModel = getIt<UserViewModel>();
    
    // 載入使用者資料
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _viewModel.loadUserProfile(widget.userId);
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('個人資料'),
        actions: [
          IconButton(
            icon: Icon(Icons.refresh),
            onPressed: _handleRefresh,
          ),
          PopupMenuButton<String>(
            onSelected: _handleMenuAction,
            itemBuilder: (context) => [
              PopupMenuItem(value: 'edit', child: Text('編輯')),
              PopupMenuItem(value: 'delete', child: Text('刪除帳號')),
            ],
          ),
        ],
      ),
      body: ChangeNotifierProvider.value(
        value: _viewModel,
        child: Consumer<UserViewModel>(
          builder: (context, viewModel, child) {
            return _buildBody(viewModel);
          },
        ),
      ),
    );
  }
  
  Widget _buildBody(UserViewModel viewModel) {
    if (viewModel.isLoading && !viewModel.hasUser) {
      return _buildLoadingState();
    }
    
    if (viewModel.errorMessage != null && !viewModel.hasUser) {
      return _buildErrorState(viewModel.errorMessage!);
    }
    
    if (viewModel.hasUser) {
      return _buildUserProfile(viewModel);
    }
    
    return _buildEmptyState();
  }
  
  Widget _buildLoadingState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          CircularProgressIndicator(),
          SizedBox(height: 16),
          Text('載入使用者資料中...'),
        ],
      ),
    );
  }
  
  Widget _buildErrorState(String error) {
    return Center(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 64,
              color: Colors.red,
            ),
            SizedBox(height: 16),
            Text(
              '載入失敗',
              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 8),
            Text(
              error,
              textAlign: TextAlign.center,
              style: TextStyle(color: Colors.grey[600]),
            ),
            SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => _viewModel.loadUserProfile(widget.userId),
              child: Text('重新載入'),
            ),
          ],
        ),
      ),
    );
  }
  
  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.person_outline,
            size: 64,
            color: Colors.grey,
          ),
          SizedBox(height: 16),
          Text('未找到使用者資料'),
        ],
      ),
    );
  }
  
  Widget _buildUserProfile(UserViewModel viewModel) {
    final user = viewModel.user!;
    
    return RefreshIndicator(
      onRefresh: _handleRefresh,
      child: SingleChildScrollView(
        physics: AlwaysScrollableScrollPhysics(),
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 錯誤訊息顯示
            if (viewModel.errorMessage != null)
              _buildErrorBanner(viewModel.errorMessage!),
            
            // 使用者頭像和基本資訊
            _buildUserHeader(user),
            
            SizedBox(height: 24),
            
            // 使用者詳細資訊
            _buildUserDetails(user),
            
            SizedBox(height: 24),
            
            // 操作按鈕
            _buildActionButtons(viewModel),
          ],
        ),
      ),
    );
  }
  
  Widget _buildErrorBanner(String error) {
    return Container(
      width: double.infinity,
      padding: EdgeInsets.all(12),
      margin: EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: Colors.red[100],
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.red[300]!),
      ),
      child: Row(
        children: [
          Icon(Icons.error, color: Colors.red[700]),
          SizedBox(width: 8),
          Expanded(
            child: Text(
              error,
              style: TextStyle(color: Colors.red[700]),
            ),
          ),
          IconButton(
            icon: Icon(Icons.close, color: Colors.red[700]),
            onPressed: _viewModel.clearError,
            constraints: BoxConstraints(minWidth: 24, minHeight: 24),
            padding: EdgeInsets.zero,
          ),
        ],
      ),
    );
  }
  
  Widget _buildUserHeader(User user) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Row(
          children: [
            // 頭像
            CircleAvatar(
              radius: 40,
              backgroundColor: Colors.blue[100],
              child: Text(
                user.displayName[0].toUpperCase(),
                style: TextStyle(
                  fontSize: 32,
                  fontWeight: FontWeight.bold,
                  color: Colors.blue[700],
                ),
              ),
            ),
            SizedBox(width: 16),
            
            // 基本資訊
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    user.displayName,
                    style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  SizedBox(height: 4),
                  Text(
                    user.email,
                    style: TextStyle(
                      fontSize: 14,
                      color: Colors.grey[600],
                    ),
                  ),
                  SizedBox(height: 8),
                  
                  // 狀態標籤
                  _buildStatusChip(user.status),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
  
  Widget _buildStatusChip(UserStatus status) {
    Color backgroundColor;
    Color textColor;
    String text;
    
    switch (status) {
      case UserStatus.active:
        backgroundColor = Colors.green[100]!;
        textColor = Colors.green[700]!;
        text = '活躍';
        break;
      case UserStatus.inactive:
        backgroundColor = Colors.grey[100]!;
        textColor = Colors.grey[700]!;
        text = '非活躍';
        break;
      case UserStatus.banned:
        backgroundColor = Colors.red[100]!;
        textColor = Colors.red[700]!;
        text = '已封鎖';
        break;
      case UserStatus.pending:
        backgroundColor = Colors.orange[100]!;
        textColor = Colors.orange[700]!;
        text = '等待中';
        break;
    }
    
    return Container(
      padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: backgroundColor,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Text(
        text,
        style: TextStyle(
          color: textColor,
          fontSize: 12,
          fontWeight: FontWeight.w500,
        ),
      ),
    );
  }
  
  Widget _buildUserDetails(User user) {
    return Card(
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '詳細資訊',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 16),
            
            _buildDetailItem(
              icon: Icons.person,
              label: '使用者 ID',
              value: user.id,
            ),
            
            _buildDetailItem(
              icon: Icons.email,
              label: '電子郵件',
              value: user.email,
            ),
            
            _buildDetailItem(
              icon: Icons.access_time,
              label: '最後登入',
              value: user.lastLoginAt != null
                  ? _formatDateTime(user.lastLoginAt!)
                  : '從未登入',
            ),
            
            _buildDetailItem(
              icon: Icons.info,
              label: '帳號狀態',
              value: user.isActive ? '正常' : '非活躍',
            ),
            
            if (user.isNewUser)
              _buildDetailItem(
                icon: Icons.new_releases,
                label: '帳號類型',
                value: '新使用者',
              ),
          ],
        ),
      ),
    );
  }
  
  Widget _buildDetailItem({
    required IconData icon,
    required String label,
    required String value,
  }) {
    return Padding(
      padding: EdgeInsets.only(bottom: 12),
      child: Row(
        children: [
          Icon(icon, size: 20, color: Colors.grey[600]),
          SizedBox(width: 12),
          Expanded(
            flex: 2,
            child: Text(
              label,
              style: TextStyle(
                fontWeight: FontWeight.w500,
                color: Colors.grey[700],
              ),
            ),
          ),
          Expanded(
            flex: 3,
            child: Text(
              value,
              style: TextStyle(fontWeight: FontWeight.w400),
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildActionButtons(UserViewModel viewModel) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        ElevatedButton.icon(
          onPressed: viewModel.isUpdating ? null : _handleEditProfile,
          icon: Icon(Icons.edit),
          label: Text('編輯個人資料'),
          style: ElevatedButton.styleFrom(
            padding: EdgeInsets.symmetric(vertical: 12),
          ),
        ),
        
        SizedBox(height: 12),
        
        OutlinedButton.icon(
          onPressed: viewModel.isLoading ? null : _handleChangePassword,
          icon: Icon(Icons.lock),
          label: Text('更改密碼'),
          style: OutlinedButton.styleFrom(
            padding: EdgeInsets.symmetric(vertical: 12),
          ),
        ),
        
        SizedBox(height: 12),
        
        TextButton.icon(
          onPressed: viewModel.isLoading ? null : _handleDeleteAccount,
          icon: Icon(Icons.delete, color: Colors.red),
          label: Text(
            '刪除帳號',
            style: TextStyle(color: Colors.red),
          ),
          style: TextButton.styleFrom(
            padding: EdgeInsets.symmetric(vertical: 12),
          ),
        ),
        
        // 載入指示器
        if (viewModel.isUpdating)
          Padding(
            padding: EdgeInsets.only(top: 16),
            child: Center(
              child: Column(
                children: [
                  SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(strokeWidth: 2),
                  ),
                  SizedBox(height: 8),
                  Text(
                    '更新中...',
                    style: TextStyle(fontSize: 12, color: Colors.grey[600]),
                  ),
                ],
              ),
            ),
          ),
      ],
    );
  }
  
  // 事件處理方法
  Future<void> _handleRefresh() async {
    await _viewModel.refresh();
  }
  
  void _handleMenuAction(String action) {
    switch (action) {
      case 'edit':
        _handleEditProfile();
        break;
      case 'delete':
        _handleDeleteAccount();
        break;
    }
  }
  
  void _handleEditProfile() {
    if (_viewModel.user == null) return;
    
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => EditProfilePage(user: _viewModel.user!),
      ),
    ).then((result) {
      // 如果編輯成功，重新載入資料
      if (result == true) {
        _viewModel.refresh();
      }
    });
  }
  
  void _handleChangePassword() {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ChangePasswordPage(),
      ),
    );
  }
  
  void _handleDeleteAccount() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('刪除帳號'),
        content: Text(
          '確定要刪除此帳號嗎？此操作無法復原。',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('取消'),
          ),
          TextButton(
            onPressed: () async {
              Navigator.pop(context);
              final success = await _viewModel.deleteAccount();
              if (success) {
                _showSuccessSnackBar('帳號已成功刪除');
                Navigator.pop(context); // 返回上一頁
              }
            },
            child: Text(
              '刪除',
              style: TextStyle(color: Colors.red),
            ),
          ),
        ],
      ),
    );
  }
  
  void _showSuccessSnackBar(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.green,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }
  
  String _formatDateTime(DateTime dateTime) {
    final now = DateTime.now();
    final difference = now.difference(dateTime);
    
    if (difference.inDays > 0) {
      return '${difference.inDays} 天前';
    } else if (difference.inHours > 0) {
      return '${difference.inHours} 小時前';
    } else if (difference.inMinutes > 0) {
      return '${difference.inMinutes} 分鐘前';
    } else {
      return '剛剛';
    }
  }
  
  @override
  void dispose() {
    // 清理資源
    super.dispose();
  }
}
```

------

## 🔄 UseCase 層 (業務邏輯)

```dart
// 📋 UseCase (用例層)
// 位置: lib/domain/usecases/

// 基礎 UseCase 抽象類別
abstract class UseCase<Type, Params> {
  Future<Either<Failure, Type>> execute(Params params);
}

abstract class UseCaseNoParams<Type> {
  Future<Either<Failure, Type>> execute();
}

// 取得使用者個人資料用例
class GetUserProfileUseCase implements UseCase<User, String> {
  final UserRepository _repository;
  
  GetUserProfileUseCase(this._repository);
  
  @override
  Future<Either<Failure, User>> execute(String userId) async {
    try {
      // 驗證輸入參數
      if (userId.isEmpty) {
        return Left(ValidationFailure('使用者 ID 不能為空'));
      }
      
      // 呼叫儲存庫
      final user = await _repository.getUserById(userId);
      
      if (user == null) {
        return Left(NotFoundFailure('找不到指定的使用者'));
      }
      
      return Right(user);
    } catch (error) {
      return Left(ServerFailure('取得使用者資料失敗: $error'));
    }
  }
}

// 更新使用者個人資料用例
class UpdateUserProfileUseCase implements UseCase<User, UpdateUserParams> {
  final UserRepository _repository;
  final ValidationService _validationService;
  
  UpdateUserProfileUseCase(
    this._repository,
    this._validationService,
  );
  
  @override
  Future<Either<Failure, User>> execute(UpdateUserParams params) async {
    try {
      // 驗證輸入資料
      final validationResult = _validationService.validateUser(params.user);
      if (!validationResult.isValid) {
        return Left(ValidationFailure(validationResult.errorMessage));
      }
      
      // 檢查使用者是否存在
      final existingUser = await _repository.getUserById(params.user.id);
      if (existingUser == null) {
        return Left(NotFoundFailure('使用者不存在'));
      }
      
      // 檢查電子郵件是否已被其他使用者使用
      if (params.user.email != existingUser.email) {
        final emailExists = await _repository.isEmailExists(params.user.email);
        if (emailExists) {
          return Left(ValidationFailure('此電子郵件已被使用'));
        }
      }
      
      // 執行更新
      final updatedUser = await _repository.updateUser(params.user);
      
      return Right(updatedUser);
    } catch (error) {
      return Left(ServerFailure('更新使用者資料失敗: $error'));
    }
  }
}

// 參數類別
class UpdateUserParams {
  final User user;
  
  UpdateUserParams({required this.user});
}

// 搜尋使用者用例
class SearchUsersUseCase implements UseCase<List<User>, SearchUsersParams> {
  final UserRepository _repository;
  
  SearchUsersUseCase(this._repository);
  
  @override
  Future<Either<Failure, List<User>>> execute(SearchUsersParams params) async {
    try {
      // 驗證搜尋查詢
      if (params.query.trim().length < 2) {
        return Left(ValidationFailure('搜尋關鍵字至少需要 2 個字元'));
      }
      
      // 執行搜尋
      final users = await _repository.searchUsers(
        params.query,
        page: params.page,
        limit: params.limit,
      );
      
      return Right(users);
    } catch (error) {
      return Left(ServerFailure('搜尋使用者失敗: $error'));
    }
  }
}

class SearchUsersParams {
  final String query;
  final int page;
  final int limit;
  
  SearchUsersParams({
    required this.query,
    this.page = 1,
    this.limit = 20,
  });
}

// 刪除使用者帳號用例
class DeleteUserAccountUseCase implements UseCase<void, String> {
  final UserRepository _repository;
  final AuthRepository _authRepository;
  
  DeleteUserAccountUseCase(
    this._repository,
    this._authRepository,
  );
  
  @override
  Future<Either<Failure, void>> execute(String userId) async {
    try {
      // 檢查使用者是否存在
      final user = await _repository.getUserById(userId);
      if (user == null) {
        return Left(NotFoundFailure('使用者不存在'));
      }
      
      // 檢查是否為當前登入使用者
      final currentUser = await _authRepository.getCurrentUser();
      if (currentUser?.id != userId) {
        return Left(UnauthorizedFailure('只能刪除自己的帳號'));
      }
      
      // 執行刪除操作
      await _repository.deleteUser(userId);
      
      // 登出使用者
      await _authRepository.logout();
      
      return Right(null);
    } catch (error) {
      return Left(ServerFailure('刪除帳號失敗: $error'));
    }
  }
}
```

------

## 🗃️ 資料源設計

```dart
// 🌐 Remote Data Source (遠端資料源)
// 位置: lib/data/datasources/remote/

abstract class UserRemoteDataSource {
  Future<UserResponse> getUserById(String id);
  Future<List<UserResponse>> getUsers({int page = 1, int limit = 20});
  Future<UserResponse> createUser(UserResponse user);
  Future<UserResponse> updateUser(UserResponse user);
  Future<void> deleteUser(String id);
  Future<List<UserResponse>> searchUsers(String query, {int page = 1, int limit = 20});
  Future<bool> isEmailExists(String email);
}

class UserRemoteDataSourceImpl implements UserRemoteDataSource {
  final ApiClient _apiClient;
  final String _baseUrl = '/api/v1/users';
  
  UserRemoteDataSourceImpl({required ApiClient apiClient})
      : _apiClient = apiClient;
  
  @override
  Future<UserResponse> getUserById(String id) async {
    try {
      final response = await _apiClient.get('$_baseUrl/$id');
      
      if (response.statusCode == 200) {
        return UserResponse.fromJson(response.data);
      } else {
        throw ServerException('取得使用者資料失敗: ${response.statusCode}');
      }
    } catch (error) {
      throw ServerException('網路錯誤: $error');
    }
  }
  
  @override
  Future<List<UserResponse>> getUsers({int page = 1, int limit = 20}) async {
    try {
      final response = await _apiClient.get(
        _baseUrl,
        queryParameters: {
          'page': page,
          'limit': limit,
        },
      );
      
      if (response.statusCode == 200) {
        final List<dynamic> jsonList = response.data['data'];
        return jsonList.map((json) => UserResponse.fromJson(json)).toList();
      } else {
        throw ServerException('取得使用者列表失敗: ${response.statusCode}');
      }
    } catch (error) {
      throw ServerException('網路錯誤: $error');
    }
  }
  
  @override
  Future<UserResponse> createUser(UserResponse user) async {
    try {
      final response = await _apiClient.post(
        _baseUrl,
        data: user.toJson(),
      );
      
      if (response.statusCode == 201) {
        return UserResponse.fromJson(response.data);
      } else {
        throw ServerException('建立使用者失敗: ${response.statusCode}');
      }
    } catch (error) {
      throw ServerException('網路錯誤: $error');
    }
  }
  
  @override
  Future<UserResponse> updateUser(UserResponse user) async {
    try {
      final response = await _apiClient.put(
        '$_baseUrl/${user.id}',
        data: user.toJson(),
      );
      
      if (response.statusCode == 200) {
        return UserResponse.fromJson(response.data);
      } else {
        throw ServerException('更新使用者失敗: ${response.statusCode}');
      }
    } catch (error) {
      throw ServerException('網路錯誤: $error');
    }
  }
  
  @override
  Future<void> deleteUser(String id) async {
    try {
      final response = await _apiClient.delete('$_baseUrl/$id');
      
      if (response.statusCode != 204) {
        throw ServerException('刪除使用者失敗: ${response.statusCode}');
      }
    } catch (error) {
      throw ServerException('網路錯誤: $error');
    }
  }
  
  @override
  Future<List<UserResponse>> searchUsers(
    String query, {
    int page = 1,
    int limit = 20,
  }) async {
    try {
      final response = await _apiClient.get(
        '$_baseUrl/search',
        queryParameters: {
          'q': query,
          'page': page,
          'limit': limit,
        },
      );
      
      if (response.statusCode == 200) {
        final List<dynamic> jsonList = response.data['data'];
        return jsonList.map((json) => UserResponse.fromJson(json)).toList();
      } else {
        throw ServerException('搜尋使用者失敗: ${response.statusCode}');
      }
    } catch (error) {
      throw ServerException('網路錯誤: $error');
    }
  }
  
  @override
  Future<bool> isEmailExists(String email) async {
    try {
      final response = await _apiClient.get(
        '$_baseUrl/check-email',
        queryParameters: {'email': email},
      );
      
      if (response.statusCode == 200) {
        return response.data['exists'] == true;
      } else {
        throw ServerException('檢查電子郵件失敗: ${response.statusCode}');
      }
    } catch (error) {
      throw ServerException('網路錯誤: $error');
    }
  }
}

// 💾 Local Data Source (本地資料源)
// 位置: lib/data/datasources/local/

abstract class UserLocalDataSource {
  Future<UserResponse?> getUserById(String id);
  Future<List<UserResponse>> getCachedUsers({int page = 1, int limit = 20});
  Future<void> cacheUser(UserResponse user);
  Future<void> cacheUsers(List<UserResponse> users);
  Future<void> deleteUser(String id);
  Future<void> clearCache();
  Future<List<UserResponse>> searchCachedUsers(String query);
}

class UserLocalDataSourceImpl implements UserLocalDataSource {
  final LocalStorage _localStorage;
  final String _usersKey = 'cached_users';
  final String _userPrefix = 'user_';
  
  UserLocalDataSourceImpl({required LocalStorage localStorage})
      : _localStorage = localStorage;
  
  @override
  Future<UserResponse?> getUserById(String id) async {
    try {
      final userData = await _localStorage.getString('$_userPrefix$id');
      if (userData != null) {
        final jsonData = jsonDecode(userData);
        return UserResponse.fromJson(jsonData);
      }
      return null;
    } catch (error) {
      throw CacheException('取得快取使用者資料失敗: $error');
    }
  }
  
  @override
  Future<List<UserResponse>> getCachedUsers({int page = 1, int limit = 20}) async {
    try {
      final usersData = await _localStorage.getString(_usersKey);
      if (usersData != null) {
        final List<dynamic> jsonList = jsonDecode(usersData);
        final users = jsonList.map((json) => UserResponse.fromJson(json)).toList();
        
        // 實作分頁
        final startIndex = (page - 1) * limit;
        final endIndex = startIndex + limit;
        
        if (startIndex >= users.length) {
          return [];
        }
        
        return users.sublist(
          startIndex,
          endIndex > users.length ? users.length : endIndex,
        );
      }
      return [];
    } catch (error) {
      throw CacheException('取得快取使用者列表失敗: $error');
    }
  }
  
  @override
  Future<void> cacheUser(UserResponse user) async {
    try {
      // 快取個別使用者
      await _localStorage.setString(
        '$_userPrefix${user.id}',
        jsonEncode(user.toJson()),
      );
      
      // 更新使用者列表快取
      final users = await getCachedUsers(page: 1, limit: 1000); // 取得所有快取的使用者
      final userIndex = users.indexWhere((u) => u.id == user.id);
      
      if (userIndex != -1) {
        users[userIndex] = user; // 更新現有使用者
      } else {
        users.add(user); // 新增使用者
      }
      
      await _localStorage.setString(
        _usersKey,
        jsonEncode(users.map((u) => u.toJson()).toList()),
      );
    } catch (error) {
      throw CacheException('快取使用者資料失敗: $error');
    }
  }
  
  @override
  Future<void> cacheUsers(List<UserResponse> users) async {
    try {
      // 快取使用者列表
      await _localStorage.setString(
        _usersKey,
        jsonEncode(users.map((u) => u.toJson()).toList()),
      );
      
      // 個別快取每個使用者
      for (final user in users) {
        await _localStorage.setString(
          '$_userPrefix${user.id}',
          jsonEncode(user.toJson()),
        );
      }
    } catch (error) {
      throw CacheException('快取使用者列表失敗: $error');
    }
  }
  
  @override
  Future<void> deleteUser(String id) async {
    try {
      // 刪除個別使用者快取
      await _localStorage.remove('$_userPrefix$id');
      
      // 從使用者列表快取中移除
      final users = await getCachedUsers(page: 1, limit: 1000);
      users.removeWhere((user) => user.id == id);
      
      await _localStorage.setString(
        _usersKey,
        jsonEncode(users.map((u) => u.toJson()).toList()),
      );
    } catch (error) {
      throw CacheException('刪除快取使用者失敗: $error');
    }
  }
  
  @override
  Future<void> clearCache() async {
    try {
      await _localStorage.remove(_usersKey);
      
      // 刪除所有個別使用者快取
      final keys = await _localStorage.getKeys();
      for (final key in keys) {
        if (key.startsWith(_userPrefix)) {
          await _localStorage.remove(key);
        }
      }
    } catch (error) {
      throw CacheException('清除使用者快取失敗: $error');
    }
  }
  
  @override
  Future<List<UserResponse>> searchCachedUsers(String query) async {
    try {
      final users = await getCachedUsers(page: 1, limit: 1000);
      final lowerQuery = query.toLowerCase();
      
      return users.where((user) {
        return user.name.toLowerCase().contains(lowerQuery) ||
               user.email.toLowerCase().contains(lowerQuery);
      }).toList();
    } catch (error) {
      throw CacheException('搜尋快取使用者失敗: $error');
    }
  }
}
```

------

## 🏭 依賴注入設定

```dart
// 🔧 Dependency Injection Setup
// 位置: lib/core/injection/injection.dart

import 'package:get_it/get_it.dart';
import 'package:dio/dio.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:connectivity_plus/connectivity_plus.dart';

final GetIt getIt = GetIt.instance;

Future<void> configureDependencies() async {
  // 🔌 外部依賴 (Third-party)
  await _registerExternalDependencies();
  
  // 🏗️ 核心服務
  _registerCoreServices();
  
  // 🗃️ 資料層
  _registerDataLayer();
  
  // 📋 業務邏輯層
  _registerDomainLayer();
  
  // 🎨 表現層
  _registerPresentationLayer();
}

Future<void> _registerExternalDependencies() async {
  // SharedPreferences
  final sharedPreferences = await SharedPreferences.getInstance();
  getIt.registerLazySingleton<SharedPreferences>(() => sharedPreferences);
  
  // Connectivity
  getIt.registerLazySingleton<Connectivity>(() => Connectivity());
  
  // Dio HTTP Client
  final dio = Dio();
  dio.options.baseUrl = AppConfig.apiBaseUrl;
  dio.options.connectTimeout = Duration(seconds: 30);
  dio.options.receiveTimeout = Duration(seconds: 30);
  
  // 添加攔截器
  dio.interceptors.add(AuthInterceptor());
  dio.interceptors.add(LoggingInterceptor());
  dio.interceptors.add(ErrorInterceptor());
  
  getIt.registerLazySingleton<Dio>(() => dio);
}

void _registerCoreServices() {
  // 🌐 網路相關
  getIt.registerLazySingleton<NetworkInfo>(
    () => NetworkInfoImpl(connectivity: getIt()),
  );
  
  getIt.registerLazySingleton<ApiClient>(
    () => ApiClientImpl(dio: getIt()),
  );
  
  // 💾 儲存相關
  getIt.registerLazySingleton<LocalStorage>(
    () => SharedPrefsStorage(sharedPreferences: getIt()),
  );
  
  getIt.registerLazySingleton<SecureStorage>(
    () => SecureStorageImpl(),
  );
  
  // 🛡️ 安全和驗證
  getIt.registerLazySingleton<ValidationService>(
    () => ValidationServiceImpl(),
  );
  
  getIt.registerLazySingleton<EncryptionService>(
    () => EncryptionServiceImpl(),
  );
  
  // 📊 分析和日誌
  getIt.registerLazySingleton<LoggingService>(
    () => LoggingServiceImpl(),
  );
  
  getIt.registerLazySingleton<AnalyticsService>(
    () => AnalyticsServiceImpl(),
  );
}

void _registerDataLayer() {
  // 🌐 Remote Data Sources
  getIt.registerLazySingleton<AuthRemoteDataSource>(
    () => AuthRemoteDataSourceImpl(apiClient: getIt()),
  );
  
  getIt.registerLazySingleton<UserRemoteDataSource>(
    () => UserRemoteDataSourceImpl(apiClient: getIt()),
  );
  
  getIt.registerLazySingleton<ProductRemoteDataSource>(
    () => ProductRemoteDataSourceImpl(apiClient: getIt()),
  );
  
  // 💾 Local Data Sources
  getIt.registerLazySingleton<AuthLocalDataSource>(
    () => AuthLocalDataSourceImpl(
      localStorage: getIt(),
      secureStorage: getIt(),
    ),
  );
  
  getIt.registerLazySingleton<UserLocalDataSource>(
    () => UserLocalDataSourceImpl(localStorage: getIt()),
  );
  
  getIt.registerLazySingleton<ProductLocalDataSource>(
    () => ProductLocalDataSourceImpl(localStorage: getIt()),
  );
  
  // 🗃️ Repositories
  getIt.registerLazySingleton<AuthRepository>(
    () => AuthRepositoryImpl(
      remoteDataSource: getIt(),
      localDataSource: getIt(),
      networkInfo: getIt(),
    ),
  );
  
  getIt.registerLazySingleton<UserRepository>(
    () => UserRepositoryImpl(
      remoteDataSource: getIt(),
      localDataSource: getIt(),
      networkInfo: getIt(),
    ),
  );
  
  getIt.registerLazySingleton<ProductRepository>(
    () => ProductRepositoryImpl(
      remoteDataSource: getIt(),
      localDataSource: getIt(),
      networkInfo: getIt(),
    ),
  );
}

void _registerDomainLayer() {
  // 🔐 Authentication Use Cases
  getIt.registerLazySingleton<LoginUseCase>(
    () => LoginUseCase(
      repository: getIt(),
      validationService: getIt(),
    ),
  );
  
  getIt.registerLazySingleton<LogoutUseCase>(
    () => LogoutUseCase(repository: getIt()),
  );
  
  getIt.registerLazySingleton<RegisterUseCase>(
    () => RegisterUseCase(
      repository: getIt(),
      validationService: getIt(),
    ),
  );
  
  getIt.registerLazySingleton<RefreshTokenUseCase>(
    () => RefreshTokenUseCase(repository: getIt()),
  );
  
  // 👤 User Use Cases
  getIt.registerLazySingleton<GetUserProfileUseCase>(
    () => GetUserProfileUseCase(getIt()),
  );
  
  getIt.registerLazySingleton<UpdateUserProfileUseCase>(
    () => UpdateUserProfileUseCase(
      getIt(),
      getIt<ValidationService>(),
    ),
  );
  
  getIt.registerLazySingleton<DeleteUserAccountUseCase>(
    () => DeleteUserAccountUseCase(
      getIt<UserRepository>(),
      getIt<AuthRepository>(),
    ),
  );
  
  getIt.registerLazySingleton<SearchUsersUseCase>(
    () => SearchUsersUseCase(getIt()),
  );
  
  // 🛍️ Product Use Cases
  getIt.registerLazySingleton<GetProductsUseCase>(
    () => GetProductsUseCase(getIt()),
  );
  
  getIt.registerLazySingleton<GetProductDetailUseCase>(
    () => GetProductDetailUseCase(getIt()),
  );
  
  getIt.registerLazySingleton<SearchProductsUseCase>(
    () => SearchProductsUseCase(getIt()),
  );
}

void _registerPresentationLayer() {
  // 🔐 Authentication ViewModels
  getIt.registerFactory<AuthViewModel>(
    () => AuthViewModel(
      loginUseCase: getIt(),
      logoutUseCase: getIt(),
      registerUseCase: getIt(),
      refreshTokenUseCase: getIt(),
    ),
  );
  
  // 👤 User ViewModels
  getIt.registerFactory<UserViewModel>(
    () => UserViewModel(
      getUserProfileUseCase: getIt(),
      updateUserProfileUseCase: getIt(),
      deleteUserAccountUseCase: getIt(),
    ),
  );
  
  getIt.registerFactory<UserListViewModel>(
    () => UserListViewModel(
      searchUsersUseCase: getIt(),
    ),
  );
  
  // 🛍️ Product ViewModels
  getIt.registerFactory<ProductViewModel>(
    () => ProductViewModel(
      getProductsUseCase: getIt(),
      getProductDetailUseCase: getIt(),
      searchProductsUseCase: getIt(),
    ),
  );
  
  // 🎨 UI Services
  getIt.registerLazySingleton<NavigationService>(
    () => NavigationServiceImpl(),
  );
  
  getIt.registerLazySingleton<DialogService>(
    () => DialogServiceImpl(),
  );
  
  getIt.registerLazySingleton<SnackBarService>(
    () => SnackBarServiceImpl(),
  );
  
  getIt.registerLazySingleton<ThemeService>(
    () => ThemeServiceImpl(localStorage: getIt()),
  );
}

// 🧹 清理依賴 (用於測試)
Future<void> resetDependencies() async {
  await getIt.reset();
}
```

------

## 🔀 狀態管理策略

### Provider 狀態管理實作

```dart
// 🎯 多 Provider 設定
// 位置: lib/main.dart

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // 配置依賴注入
  await configureDependencies();
  
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        // 🔐 認證狀態
        ChangeNotifierProvider<AuthViewModel>(
          create: (_) => getIt<AuthViewModel>(),
        ),
        
        // 👤 使用者狀態
        ChangeNotifierProvider<UserViewModel>(
          create: (_) => getIt<UserViewModel>(),
        ),
        
        // 🛍️ 產品狀態
        ChangeNotifierProvider<ProductViewModel>(
          create: (_) => getIt<ProductViewModel>(),
        ),
        
        // 🎨 主題狀態
        ChangeNotifierProvider<ThemeViewModel>(
          create: (_) => getIt<ThemeViewModel>(),
        ),
        
        // 🌐 應用程式狀態
        ChangeNotifierProvider<AppViewModel>(
          create: (_) => getIt<AppViewModel>(),
        ),
      ],
      child: Consumer<ThemeViewModel>(
        builder: (context, themeViewModel, child) {
          return MaterialApp(
            title: 'Flutter MVVM App',
            theme: themeViewModel.lightTheme,
            darkTheme: themeViewModel.darkTheme,
            themeMode: themeViewModel.themeMode,
            initialRoute: AppRoutes.splash,
            onGenerateRoute: AppRouter.generateRoute,
            navigatorKey: getIt<NavigationService>().navigatorKey,
            builder: (context, child) {
              return AppErrorBoundary(
                child: child ?? Container(),
              );
            },
          );
        },
      ),
    );
  }
}

// 🎨 主題管理 ViewModel
class ThemeViewModel extends ChangeNotifier {
  final ThemeService _themeService;
  
  ThemeViewModel({required ThemeService themeService})
      : _themeService = themeService {
    _loadThemeMode();
  }
  
  ThemeMode _themeMode = ThemeMode.system;
  ThemeData? _customLightTheme;
  ThemeData? _customDarkTheme;
  
  ThemeMode get themeMode => _themeMode;
  
  ThemeData get lightTheme => _customLightTheme ?? AppTheme.lightTheme;
  ThemeData get darkTheme => _customDarkTheme ?? AppTheme.darkTheme;
  
  bool get isDarkMode => _themeMode == ThemeMode.dark;
  bool get isSystemMode => _themeMode == ThemeMode.system;
  
  Future<void> _loadThemeMode() async {
    _themeMode = await _themeService.getThemeMode();
    notifyListeners();
  }
  
  Future<void> setThemeMode(ThemeMode mode) async {
    _themeMode = mode;
    await _themeService.setThemeMode(mode);
    notifyListeners();
  }
  
  Future<void> toggleTheme() async {
    final newMode = _themeMode == ThemeMode.light 
        ? ThemeMode.dark 
        : ThemeMode.light;
    await setThemeMode(newMode);
  }
  
  void setCustomTheme({ThemeData? light, ThemeData? dark}) {
    _customLightTheme = light;
    _customDarkTheme = dark;
    notifyListeners();
  }
}

// 🌐 應用程式全域狀態
class AppViewModel extends ChangeNotifier {
  final NetworkInfo _networkInfo;
  final AnalyticsService _analyticsService;
  
  AppViewModel({
    required NetworkInfo networkInfo,
    required AnalyticsService analyticsService,
  }) : _networkInfo = networkInfo,
       _analyticsService = analyticsService {
    _initializeApp();
  }
  
  bool _isInitialized = false;
  bool _isConnected = true;
  String? _appVersion;
  Map<String, dynamic> _featureFlags = {};
  
  // Getters
  bool get isInitialized => _isInitialized;
  bool get isConnected => _isConnected;
  String? get appVersion => _appVersion;
  Map<String, dynamic> get featureFlags => _featureFlags;
  
  Future<void> _initializeApp() async {
    try {
      // 載入應用程式版本
      _appVersion = await _getAppVersion();
      
      // 檢查網路連線
      await _checkConnectivity();
      
      // 載入功能開關
      await _loadFeatureFlags();
      
      // 初始化分析服務
      await _analyticsService.initialize();
      
      _isInitialized = true;
      notifyListeners();
    } catch (error) {
      print('應用程式初始化失敗: $error');
    }
  }
  
  Future<void> _checkConnectivity() async {
    _isConnected = await _networkInfo.isConnected;
    
    // 監聽網路狀態變化
    _networkInfo.onConnectivityChanged.listen((isConnected) {
      if (_isConnected != isConnected) {
        _isConnected = isConnected;
        notifyListeners();
        
        // 記錄網路狀態變化
        _analyticsService.logEvent('network_status_changed', {
          'is_connected': isConnected,
        });
      }
    });
  }
  
  Future<String> _getAppVersion() async {
    final packageInfo = await PackageInfo.fromPlatform();
    return '${packageInfo.version}+${packageInfo.buildNumber}';
  }
  
  Future<void> _loadFeatureFlags() async {
    // 這裡可以從遠端配置服務載入功能開關
    // 例如 Firebase Remote Config
    _featureFlags = {
      'new_user_onboarding': true,
      'dark_mode_enabled': true,
      'push_notifications': true,
      'analytics_enabled': true,
    };
  }
  
  bool isFeatureEnabled(String featureName) {
    return _featureFlags[featureName] == true;
  }
  
  void updateFeatureFlag(String featureName, bool enabled) {
    _featureFlags[featureName] = enabled;
    notifyListeners();
    
    _analyticsService.logEvent('feature_flag_changed', {
      'feature_name': featureName,
      'enabled': enabled,
    });
  }
}
```

### Riverpod 狀態管理實作 (替代方案)

```dart
// 🎯 Riverpod Providers
// 位置: lib/presentation/providers/app_providers.dart

// 🔐 認證相關 Providers
final authViewModelProvider = StateNotifierProvider<AuthNotifier, AuthState>(
  (ref) => AuthNotifier(
    loginUseCase: ref.read(loginUseCaseProvider),
    logoutUseCase: ref.read(logoutUseCaseProvider),
    registerUseCase: ref.read(registerUseCaseProvider),
  ),
);

final currentUserProvider = Provider<User?>((ref) {
  final authState = ref.watch(authViewModelProvider);
  return authState.maybeWhen(
    authenticated: (user) => user,
    orElse: () => null,
  );
});

// 👤 使用者相關 Providers
final userViewModelProvider = StateNotifierProvider.family<UserNotifier, UserState, String>(
  (ref, userId) => UserNotifier(
    userId: userId,
    getUserProfileUseCase: ref.read(getUserProfileUseCaseProvider),
    updateUserProfileUseCase: ref.read(updateUserProfileUseCaseProvider),
  ),
);

final userListViewModelProvider = StateNotifierProvider<UserListNotifier, UserListState>(
  (ref) => UserListNotifier(
    searchUsersUseCase: ref.read(searchUsersUseCaseProvider),
  ),
);

// 🛍️ 產品相關 Providers
final productListProvider = StateNotifierProvider<ProductListNotifier, ProductListState>(
  (ref) => ProductListNotifier(
    getProductsUseCase: ref.read(getProductsUseCaseProvider),
  ),
);

final productDetailProvider = StateNotifierProvider.family<ProductDetailNotifier, ProductDetailState, String>(
  (ref, productId) => ProductDetailNotifier(
    productId: productId,
    getProductDetailUseCase: ref.read(getProductDetailUseCaseProvider),
  ),
);

// 🎨 主題 Provider
final themeProvider = StateNotifierProvider<ThemeNotifier, ThemeState>(
  (ref) => ThemeNotifier(
    themeService: ref.read(themeServiceProvider),
  ),
);

// 🌐 應用程式狀態 Provider
final appStateProvider = StateNotifierProvider<AppStateNotifier, AppState>(
  (ref) => AppStateNotifier(
    networkInfo: ref.read(networkInfoProvider),
    analyticsService: ref.read(analyticsServiceProvider),
  ),
);

// 使用範例
class MyRiverpodApp extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final themeState = ref.watch(themeProvider);
    final appState = ref.watch(appStateProvider);
    
    if (!appState.isInitialized) {
      return MaterialApp(
        home: Scaffold(
          body: Center(
            child: CircularProgressIndicator(),
          ),
        ),
      );
    }
    
    return MaterialApp(
      title: 'Riverpod MVVM App',
      theme: themeState.lightTheme,
      darkTheme: themeState.darkTheme,
      themeMode: themeState.themeMode,
      initialRoute: AppRoutes.splash,
      onGenerateRoute: AppRouter.generateRoute,
    );
  }
}
```

------

## 🧩 錯誤處理與異常管理

```dart
// 🚨 錯誤處理系統
// 位置: lib/core/errors/

// 基礎錯誤類別
abstract class Failure {
  final String message;
  final int? code;
  final dynamic originalError;
  
  const Failure({
    required this.message,
    this.code,
    this.originalError,
  });
  
  @override
  String toString() => 'Failure(message: $message, code: $code)';
}

// 具體錯誤類型
class ServerFailure extends Failure {
  const ServerFailure(String message, {int? code, dynamic originalError})
      : super(message: message, code: code, originalError: originalError);
}

class NetworkFailure extends Failure {
  const NetworkFailure(String message, {int? code, dynamic originalError})
      : super(message: message, code: code, originalError: originalError);
}

class ValidationFailure extends Failure {
  const ValidationFailure(String message, {int? code, dynamic originalError})
      : super(message: message, code: code, originalError: originalError);
}

class AuthenticationFailure extends Failure {
  const AuthenticationFailure(String message, {int? code, dynamic originalError})
      : super(message: message, code: code, originalError: originalError);
}

class AuthorizationFailure extends Failure {
  const AuthorizationFailure(String message, {int? code, dynamic originalError})
      : super(message: message, code: code, originalError: originalError);
}

class NotFoundFailure extends Failure {
  const NotFoundFailure(String message, {int? code, dynamic originalError})
      : super(message: message, code: code, originalError: originalError);
}

class CacheFailure extends Failure {
  const CacheFailure(String message, {int? code, dynamic originalError})
      : super(message: message, code: code, originalError: originalError);
}

// 異常類別
class ServerException implements Exception {
  final String message;
  final int? statusCode;
  
  ServerException(this.message, {this.statusCode});
  
  @override
  String toString() => 'ServerException: $message (Code: $statusCode)';
}

class NetworkException implements Exception {
  final String message;
  
  NetworkException(this.message);
  
  @override
  String toString() => 'NetworkException: $message';
}

class CacheException implements Exception {
  final String message;
  
  CacheException(this.message);
  
  @override
  String toString() => 'CacheException: $message';
}

class ValidationException implements Exception {
  final String message;
  final Map<String, String>? fieldErrors;
  
  ValidationException(this.message, {this.fieldErrors});
  
  @override
  String toString() => 'ValidationException: $message';
}

// 錯誤處理器
class ErrorHandler {
  static Failure handleError(dynamic error) {
    if (error is ServerException) {
      return ServerFailure(
        error.message,
        code: error.statusCode,
        originalError: error,
      );
    } else if (error is NetworkException) {
      return NetworkFailure(
        error.message,
        originalError: error,
      );
    } else if (error is CacheException) {
      return CacheFailure(
        error.message,
        originalError: error,
      );
    } else if (error is ValidationException) {
      return ValidationFailure(
        error.message,
        originalError: error,
      );
    } else if (error is DioError) {
      return _handleDioError(error);
    } else {
      return ServerFailure(
        '未知錯誤: ${error.toString()}',
        originalError: error,
      );
    }
  }
  
  static Failure _handleDioError(DioError error) {
    switch (error.type) {
      case DioErrorType.connectionTimeout:
      case DioErrorType.sendTimeout:
      case DioErrorType.receiveTimeout:
        return NetworkFailure('連線逾時，請檢查網路連線');
        
      case DioErrorType.badResponse:
        final statusCode = error.response?.statusCode;
        final message = error.response?.data?['message'] ?? '伺服器錯誤';
        
        switch (statusCode) {
          case 400:
            return ValidationFailure('請求參數錯誤: $message', code: statusCode);
          case 401:
            return AuthenticationFailure('身份驗證失敗', code: statusCode);
          case 403:
            return AuthorizationFailure('權限不足', code: statusCode);
          case 404:
            return NotFoundFailure('資源未找到', code: statusCode);
          case 500:
          default:
            return ServerFailure('伺服器錯誤: $message', code: statusCode);
        }
        
      case DioErrorType.cancel:
        return NetworkFailure('請求已取消');
        
      case DioErrorType.unknown:
      default:
        if (error.error is SocketException) {
          return NetworkFailure('網路連線失敗，請檢查網路設定');
        }
        return ServerFailure('未知網路錯誤: ${error.message}');
    }
  }
}

// 全域錯誤邊界 Widget
class AppErrorBoundary extends StatefulWidget {
  final Widget child;
  
  const AppErrorBoundary({Key? key, required this.child}) : super(key: key);
  
  @override
  State<AppErrorBoundary> createState() => _AppErrorBoundaryState();
}

class _AppErrorBoundaryState extends State<AppErrorBoundary> {
  ErrorWidgetBuilder? _oldErrorWidgetBuilder;
  
  @override
  void initState() {
    super.initState();
    
    // 設定全域錯誤處理
    _oldErrorWidgetBuilder = ErrorWidget.builder;
    ErrorWidget.builder = (FlutterErrorDetails details) {
      // 記錄錯誤
      getIt<LoggingService>().logError(
        details.exception,
        details.stack,
        details.context?.toString(),
      );
      
      // 回傳自訂錯誤 Widget
      return _buildErrorWidget(details);
    };
    
    // 設定 Flutter 錯誤處理
    FlutterError.onError = (FlutterErrorDetails details) {
      getIt<LoggingService>().logError(
        details.exception,
        details.stack,
        details.context?.toString(),
      );
      
      // 在 debug 模式下顯示詳細錯誤
      if (kDebugMode) {
        FlutterError.presentError(details);
      }
    };
  }
  
  @override
  void dispose() {
    // 恢復原始錯誤處理器
    ErrorWidget.builder = _oldErrorWidgetBuilder!;
    super.dispose();
  }
  
  Widget _buildErrorWidget(FlutterErrorDetails details) {
    return Material(
      child: Container(
        padding: EdgeInsets.all(16),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 48,
              color: Colors.red,
            ),
            SizedBox(height: 16),
            Text(
              '應用程式發生錯誤',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 8),
            if (kDebugMode) ...[
              Text(
                details.exception.toString(),
                textAlign: TextAlign.center,
                style: TextStyle(fontSize: 12),
              ),
              SizedBox(height: 16),
            ],
            ElevatedButton(
              onPressed: () {
                // 重新啟動應用程式
                runApp(MyApp());
              },
              child: Text('重新啟動'),
            ),
          ],
        ),
      ),
    );
  }
  
  @override
  Widget build(BuildContext context) {
    return widget.child;
  }
}
```

## 🧪 測試基礎設定

```dart
// 🧪 測試基礎設定
// 位置: test/helpers/test_helper.dart

import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:mockito/annotations.dart';
import 'package:provider/provider.dart';
import 'package:network_image_mock/network_image_mock.dart';

// 測試輔助工具
class TestHelper {
  // Mock 資料
  static User createMockUser({
    String? id,
    String? name,
    String? email,
    UserStatus? status,
  }) {
    return User(
      id: id ?? 'test_user_id',
      name: name ?? 'Test User',
      email: email ?? 'test@example.com',
      status: status ?? UserStatus.active,
      lastLoginAt: DateTime.now(),
    );
  }
  
  static List<User> createMockUserList(int count) {
    return List.generate(count, (index) => createMockUser(
      id: 'user_$index',
      name: 'User $index',
      email: 'user$index@example.com',
    ));
  }
  
  static AuthToken createMockAuthToken({
    String? token,
    DateTime? expiresAt,
  }) {
    return AuthToken(
      accessToken: token ?? 'mock_access_token',
      refreshToken: 'mock_refresh_token',
      tokenType: 'Bearer',
      expiresAt: expiresAt ?? DateTime.now().add(Duration(hours: 1)),
    );
  }
  
  static ApiResponse<T> createMockApiResponse<T>({
    required T data,
    bool success = true,
    int statusCode = 200,
    String? error,
  }) {
    if (success) {
      return ApiResponse.success(data, statusCode);
    } else {
      return ApiResponse.failure(error ?? 'Mock error', statusCode);
    }
  }
  
  // 測試用的 Widget 包裝器
  static Widget wrapWithMaterialApp(
    Widget child, {
    ThemeData? theme,
    Locale? locale,
    List<Locale>? supportedLocales,
    NavigatorObserver? navigatorObserver,
  }) {
    return MaterialApp(
      theme: theme,
      locale: locale,
      supportedLocales: supportedLocales ?? [Locale('en', 'US')],
      navigatorObservers: navigatorObserver != null ? [navigatorObserver] : [],
      home: Scaffold(body: child),
    );
  }
  
  static Widget wrapWithProviders(
    Widget child, {
    UserViewModel? userViewModel,
    AuthViewModel? authViewModel,
    ThemeViewModel? themeViewModel,
  }) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider<UserViewModel>(
          create: (_) => userViewModel ?? MockUserViewModel(),
        ),
        ChangeNotifierProvider<AuthViewModel>(
          create: (_) => authViewModel ?? MockAuthViewModel(),
        ),
        ChangeNotifierProvider<ThemeViewModel>(
          create: (_) => themeViewModel ?? MockThemeViewModel(),
        ),
      ],
      child: wrapWithMaterialApp(child),
    );
  }
  
  static Widget wrapWithMediaQuery(
    Widget child, {
    double width = 400,
    double height = 800,
    double devicePixelRatio = 1.0,
    Brightness platformBrightness = Brightness.light,
  }) {
    return MediaQuery(
      data: MediaQueryData(
        size: Size(width, height),
        devicePixelRatio: devicePixelRatio,
        platformBrightness: platformBrightness,
      ),
      child: child,
    );
  }
  
  // 非同步操作輔助
  static Future<void> pumpAndSettle(
    WidgetTester tester, {
    Duration timeout = const Duration(seconds: 10),
  }) async {
    await tester.pumpAndSettle(timeout);
  }
  
  static Future<void> pumpFrames(
    WidgetTester tester,
    int frames, {
    Duration duration = const Duration(milliseconds: 16),
  }) async {
    for (int i = 0; i < frames; i++) {
      await tester.pump(duration);
    }
  }
  
  // 手勢模擬
  static Future<void> tapAndSettle(
    WidgetTester tester,
    Finder finder, {
    bool warnIfMissed = true,
  }) async {
    await tester.tap(finder, warnIfMissed: warnIfMissed);
    await pumpAndSettle(tester);
  }
  
  static Future<void> longPressAndSettle(
    WidgetTester tester,
    Finder finder, {
    bool warnIfMissed = true,
  }) async {
    await tester.longPress(finder, warnIfMissed: warnIfMissed);
    await pumpAndSettle(tester);
  }
  
  static Future<void> dragAndSettle(
    WidgetTester tester,
    Finder finder,
    Offset offset, {
    bool warnIfMissed = true,
  }) async {
    await tester.drag(finder, offset, warnIfMissed: warnIfMissed);
    await pumpAndSettle(tester);
  }
  
  // 輸入模擬
  static Future<void> enterTextAndSettle(
    WidgetTester tester,
    Finder finder,
    String text,
  ) async {
    await tester.enterText(finder, text);
    await pumpAndSettle(tester);
  }
  
  // 網路圖片模擬
  static Future<void> mockNetworkImages(
    Future<void> Function() testCode,
  ) async {
    return mockNetworkImagesFor(testCode);
  }
  
  // 驗證輔助
  static void expectWidgetExists(Finder finder, {String? reason}) {
    expect(finder, findsOneWidget, reason: reason);
  }
  
  static void expectWidgetNotExists(Finder finder, {String? reason}) {
    expect(finder, findsNothing, reason: reason);
  }
  
  static void expectWidgetCount(Finder finder, int count, {String? reason}) {
    expect(finder, findsNWidgets(count), reason: reason);
  }
  
  static void expectTextExists(String text, {String? reason}) {
    expect(find.text(text), findsOneWidget, reason: reason);
  }
  
  // 測試資料重置
  static void resetMockData() {
    // 重置所有靜態測試資料
  }
  
  // 測試環境設定
  static void setUpTestEnvironment() {
    // 設定測試環境變數
    TestWidgetsFlutterBinding.ensureInitialized();
  }
  
  static void tearDownTestEnvironment() {
    // 清理測試環境
    resetMockData();
  }
}

// Mock 類別生成器註解
@GenerateMocks([
  UserRepository,
  UserRemoteDataSource,
  UserLocalDataSource,
  AuthRepository,
  AuthRemoteDataSource,
  AuthLocalDataSource,
  NetworkInfo,
  ValidationService,
  LocalStorage,
  ApiClient,
  AnalyticsService,
  LoggingService,
])
void main() {}

// 手動 Mock 類別 (複雜行為模擬)
class MockUserViewModel extends Mock implements UserViewModel {
  @override
  User? user;
  
  @override
  bool isLoading = false;
  
  @override
  String? errorMessage;
  
  @override
  bool isUpdating = false;
  
  @override
  bool get hasUser => user != null;
  
  void setMockState({
    User? mockUser,
    bool mockIsLoading = false,
    String? mockError,
    bool mockIsUpdating = false,
  }) {
    user = mockUser;
    isLoading = mockIsLoading;
    errorMessage = mockError;
    isUpdating = mockIsUpdating;
    notifyListeners();
  }
}

class MockAuthViewModel extends Mock implements AuthViewModel {
  @override
  User? currentUser;
  
  @override
  bool isAuthenticated = false;
  
  @override
  bool isLoading = false;
  
  @override
  String? errorMessage;
  
  void setMockAuthState({
    User? mockUser,
    bool mockIsAuthenticated = false,
    bool mockIsLoading = false,
    String? mockError,
  }) {
    currentUser = mockUser;
    isAuthenticated = mockIsAuthenticated;
    isLoading = mockIsLoading;
    errorMessage = mockError;
    notifyListeners();
  }
}

class MockThemeViewModel extends Mock implements ThemeViewModel {
  @override
  ThemeMode themeMode = ThemeMode.light;
  
  @override
  bool get isDarkMode => themeMode == ThemeMode.dark;
  
  void setMockTheme(ThemeMode mode) {
    themeMode = mode;
    notifyListeners();
  }
}
```

------

## 🔬 單元測試設計

### UseCase 測試範例

```dart
// 位置: test/unit/domain/usecases/get_user_profile_usecase_test.dart

import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:dartz/dartz.dart';

import '../../../helpers/test_helper.dart';
import '../../../helpers/test_helper.mocks.dart';

void main() {
  late GetUserProfileUseCase useCase;
  late MockUserRepository mockRepository;
  
  setUp(() {
    TestHelper.setUpTestEnvironment();
    mockRepository = MockUserRepository();
    useCase = GetUserProfileUseCase(mockRepository);
  });
  
  tearDown(() {
    TestHelper.tearDownTestEnvironment();
  });
  
  group('GetUserProfileUseCase', () {
    const String testUserId = 'test_user_id';
    final User testUser = TestHelper.createMockUser(id: testUserId);
    
    test('should return User when repository call is successful', () async {
      // arrange
      when(mockRepository.getUserById(testUserId))
          .thenAnswer((_) async => testUser);
      
      // act
      final result = await useCase.execute(testUserId);
      
      // assert
      expect(result, equals(Right(testUser)));
      verify(mockRepository.getUserById(testUserId));
      verifyNoMoreInteractions(mockRepository);
    });
    
    test('should return NotFoundFailure when user does not exist', () async {
      // arrange
      when(mockRepository.getUserById(testUserId))
          .thenAnswer((_) async => null);
      
      // act
      final result = await useCase.execute(testUserId);
      
      // assert
      expect(result, equals(Left(NotFoundFailure('找不到指定的使用者'))));
      verify(mockRepository.getUserById(testUserId));
      verifyNoMoreInteractions(mockRepository);
    });
    
    test('should return ValidationFailure when userId is empty', () async {
      // act
      final result = await useCase.execute('');
      
      // assert
      expect(result, equals(Left(ValidationFailure('使用者 ID 不能為空'))));
      verifyNever(mockRepository.getUserById(any));
    });
    
    test('should return ServerFailure when repository throws exception', () async {
      // arrange
      when(mockRepository.getUserById(testUserId))
          .thenThrow(ServerException('Database connection failed'));
      
      // act
      final result = await useCase.execute(testUserId);
      
      // assert
      expect(result.isLeft(), true);
      result.fold(
        (failure) {
          expect(failure, isA<ServerFailure>());
          expect(failure.message, contains('取得使用者資料失敗'));
        },
        (user) => fail('Should return failure'),
      );
      verify(mockRepository.getUserById(testUserId));
    });
    
    test('should handle multiple concurrent calls correctly', () async {
      // arrange
      when(mockRepository.getUserById(any))
          .thenAnswer((_) async {
            await Future.delayed(Duration(milliseconds: 100));
            return testUser;
          });
      
      // act
      final futures = List.generate(
        5,
        (_) => useCase.execute(testUserId),
      );
      final results = await Future.wait(futures);
      
      // assert
      for (final result in results) {
        expect(result, equals(Right(testUser)));
      }
      verify(mockRepository.getUserById(testUserId)).called(5);
    });
  });
  
  group('Edge Cases', () {
    test('should handle null userId gracefully', () async {
      // act
      final result = await useCase.execute(null as dynamic);
      
      // assert
      expect(result.isLeft(), true);
      result.fold(
        (failure) => expect(failure, isA<ValidationFailure>()),
        (user) => fail('Should return validation failure'),
      );
    });
    
    test('should handle very long userId', () async {
      // arrange
      final longUserId = 'a' * 1000;
      when(mockRepository.getUserById(longUserId))
          .thenAnswer((_) async => TestHelper.createMockUser(id: longUserId));
      
      // act
      final result = await useCase.execute(longUserId);
      
      // assert
      expect(result.isRight(), true);
    });
  });
}
```

### Repository 測試範例

```dart
// 位置: test/unit/data/repositories/user_repository_impl_test.dart

import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';

import '../../../helpers/test_helper.dart';
import '../../../helpers/test_helper.mocks.dart';

void main() {
  late UserRepositoryImpl repository;
  late MockUserRemoteDataSource mockRemoteDataSource;
  late MockUserLocalDataSource mockLocalDataSource;
  late MockNetworkInfo mockNetworkInfo;
  
  setUp(() {
    TestHelper.setUpTestEnvironment();
    mockRemoteDataSource = MockUserRemoteDataSource();
    mockLocalDataSource = MockUserLocalDataSource();
    mockNetworkInfo = MockNetworkInfo();
    
    repository = UserRepositoryImpl(
      remoteDataSource: mockRemoteDataSource,
      localDataSource: mockLocalDataSource,
      networkInfo: mockNetworkInfo,
    );
  });
  
  tearDown(() {
    TestHelper.tearDownTestEnvironment();
  });
  
  group('getUserById', () {
    const String testUserId = 'test_user_id';
    final UserResponse testUserResponse = UserResponse(
      id: testUserId,
      name: 'Test User',
      email: 'test@example.com',
      status: 'active',
    );
    final User testUser = testUserResponse.toEntity();
    
    test('should return remote data when device is online', () async {
      // arrange
      when(mockNetworkInfo.isConnected).thenAnswer((_) async => true);
      when(mockRemoteDataSource.getUserById(testUserId))
          .thenAnswer((_) async => testUserResponse);
      when(mockLocalDataSource.cacheUser(testUserResponse))
          .thenAnswer((_) async {});
      
      // act
      final result = await repository.getUserById(testUserId);
      
      // assert
      expect(result, equals(testUser));
      verify(mockNetworkInfo.isConnected);
      verify(mockRemoteDataSource.getUserById(testUserId));
      verify(mockLocalDataSource.cacheUser(testUserResponse));
    });
    
    test('should return cached data when device is offline', () async {
      // arrange
      when(mockNetworkInfo.isConnected).thenAnswer((_) async => false);
      when(mockLocalDataSource.getUserById(testUserId))
          .thenAnswer((_) async => testUserResponse);
      
      // act
      final result = await repository.getUserById(testUserId);
      
      // assert
      expect(result, equals(testUser));
      verify(mockNetworkInfo.isConnected);
      verify(mockLocalDataSource.getUserById(testUserId));
      verifyNever(mockRemoteDataSource.getUserById(any));
    });
    
    test('should fallback to cached data when remote fails', () async {
      // arrange
      when(mockNetworkInfo.isConnected).thenAnswer((_) async => true);
      when(mockRemoteDataSource.getUserById(testUserId))
          .thenThrow(ServerException('Network error'));
      when(mockLocalDataSource.getUserById(testUserId))
          .thenAnswer((_) async => testUserResponse);
      
      // act
      final result = await repository.getUserById(testUserId);
      
      // assert
      expect(result, equals(testUser));
      verify(mockNetworkInfo.isConnected);
      verify(mockRemoteDataSource.getUserById(testUserId));
      verify(mockLocalDataSource.getUserById(testUserId));
    });
    
    test('should throw UserException when both remote and local fail', () async {
      // arrange
      when(mockNetworkInfo.isConnected).thenAnswer((_) async => true);
      when(mockRemoteDataSource.getUserById(testUserId))
          .thenThrow(ServerException('Network error'));
      when(mockLocalDataSource.getUserById(testUserId))
          .thenThrow(CacheException('Cache error'));
      
      // act & assert
      expect(
        () => repository.getUserById(testUserId),
        throwsA(isA<UserException>()),
      );
    });
    
    test('should update cache with latest remote data', () async {
      // arrange
      final cachedUserResponse = UserResponse(
        id: testUserId,
        name: 'Cached User',
        email: 'cached@example.com',
        status: 'inactive',
      );
      
      when(mockNetworkInfo.isConnected).thenAnswer((_) async => true);
      when(mockLocalDataSource.getUserById(testUserId))
          .thenAnswer((_) async => cachedUserResponse);
      when(mockRemoteDataSource.getUserById(testUserId))
          .thenAnswer((_) async => testUserResponse);
      when(mockLocalDataSource.cacheUser(testUserResponse))
          .thenAnswer((_) async {});
      
      // act
      final result = await repository.getUserById(testUserId);
      
      // assert
      expect(result, equals(testUser));
      expect(result?.name, equals('Test User')); // 確保是遠端資料
      verify(mockLocalDataSource.cacheUser(testUserResponse));
    });
  });
  
  group('createUser', () {
    final User newUser = TestHelper.createMockUser(
      id: 'new_user_id',
      name: 'New User',
    );
    
    test('should create user successfully when online', () async {
      // arrange
      when(mockNetworkInfo.isConnected).thenAnswer((_) async => true);
      final userResponse = UserResponse(
        id: newUser.id,
        name: newUser.name,
        email: newUser.email,
        status: newUser.status.toString().split('.').last,
      );
      when(mockRemoteDataSource.createUser(any))
          .thenAnswer((_) async => userResponse);
      when(mockLocalDataSource.cacheUser(userResponse))
          .thenAnswer((_) async {});
      
      // act
      final result = await repository.createUser(newUser);
      
      // assert
      expect(result.id, equals(newUser.id));
      verify(mockNetworkInfo.isConnected);
      verify(mockRemoteDataSource.createUser(any));
      verify(mockLocalDataSource.cacheUser(userResponse));
    });
    
    test('should throw NetworkException when offline', () async {
      // arrange
      when(mockNetworkInfo.isConnected).thenAnswer((_) async => false);
      
      // act & assert
      expect(
        () => repository.createUser(newUser),
        throwsA(isA<NetworkException>()),
      );
      
      verifyNever(mockRemoteDataSource.createUser(any));
      verifyNever(mockLocalDataSource.cacheUser(any));
    });
  });
}
```

### ViewModel 測試範例

```dart
// 位置: test/unit/presentation/providers/user_view_model_test.dart

import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:dartz/dartz.dart';

import '../../../helpers/test_helper.dart';
import '../../../helpers/test_helper.mocks.dart';

void main() {
  late UserViewModel viewModel;
  late MockGetUserProfileUseCase mockGetUserProfileUseCase;
  late MockUpdateUserProfileUseCase mockUpdateUserProfileUseCase;
  late MockDeleteUserAccountUseCase mockDeleteUserAccountUseCase;
  
  setUp(() {
    TestHelper.setUpTestEnvironment();
    mockGetUserProfileUseCase = MockGetUserProfileUseCase();
    mockUpdateUserProfileUseCase = MockUpdateUserProfileUseCase();
    mockDeleteUserAccountUseCase = MockDeleteUserAccountUseCase();
    
    viewModel = UserViewModel(
      getUserProfileUseCase: mockGetUserProfileUseCase,
      updateUserProfileUseCase: mockUpdateUserProfileUseCase,
      deleteUserAccountUseCase: mockDeleteUserAccountUseCase,
    );
  });
  
  tearDown(() {
    viewModel.dispose();
    TestHelper.tearDownTestEnvironment();
  });
  
  group('loadUserProfile', () {
    const String testUserId = 'test_user_id';
    final User testUser = TestHelper.createMockUser(id: testUserId);
    
    test('should load user profile successfully', () async {
      // arrange
      when(mockGetUserProfileUseCase.execute(testUserId))
          .thenAnswer((_) async => Right(testUser));
      
      // act
      await viewModel.loadUserProfile(testUserId);
      
      // assert
      expect(viewModel.user, equals(testUser));
      expect(viewModel.isLoading, false);
      expect(viewModel.errorMessage, isNull);
      expect(viewModel.hasUser, true);
      
      verify(mockGetUserProfileUseCase.execute(testUserId));
    });
    
    test('should set loading state correctly', () async {
      // arrange
      when(mockGetUserProfileUseCase.execute(testUserId))
          .thenAnswer((_) async {
            await Future.delayed(Duration(milliseconds: 100));
            return Right(testUser);
          });
      
      // act
      final future = viewModel.loadUserProfile(testUserId);
      
      // assert - during loading
      expect(viewModel.isLoading, true);
      expect(viewModel.errorMessage, isNull);
      
      await future;
      
      // assert - after loading
      expect(viewModel.isLoading, false);
      expect(viewModel.user, equals(testUser));
    });
    
    test('should handle error correctly', () async {
      // arrange
      const errorMessage = 'Failed to load user';
      when(mockGetUserProfileUseCase.execute(testUserId))
          .thenAnswer((_) async => Left(ServerFailure(errorMessage)));
      
      // act
      await viewModel.loadUserProfile(testUserId);
      
      // assert
      expect(viewModel.user, isNull);
      expect(viewModel.isLoading, false);
      expect(viewModel.errorMessage, equals(errorMessage));
      expect(viewModel.hasUser, false);
    });
    
    test('should notify listeners when state changes', () async {
      // arrange
      int notifyCount = 0;
      viewModel.addListener(() => notifyCount++);
      
      when(mockGetUserProfileUseCase.execute(testUserId))
          .thenAnswer((_) async => Right(testUser));
      
      // act
      await viewModel.loadUserProfile(testUserId);
      
      // assert
      expect(notifyCount, greaterThan(0));
    });
    
    test('should clear previous error before loading', () async {
      // arrange
      viewModel.setError('Previous error'); // 假設有這個方法用於測試
      when(mockGetUserProfileUseCase.execute(testUserId))
          .thenAnswer((_) async => Right(testUser));
      
      // act
      await viewModel.loadUserProfile(testUserId);
      
      // assert
      expect(viewModel.errorMessage, isNull);
    });
  });
  
  group('updateProfile', () {
    final User originalUser = TestHelper.createMockUser();
    final User updatedUser = originalUser.copyWith(
      name: 'Updated Name',
      email: 'updated@example.com',
    );
    
    setUp(() {
      viewModel.user = originalUser; // 設定初始使用者
    });
    
    test('should update profile successfully', () async {
      // arrange
      when(mockUpdateUserProfileUseCase.execute(any))
          .thenAnswer((_) async => Right(updatedUser));
      
      // act
      await viewModel.updateProfile(
        name: 'Updated Name',
        email: 'updated@example.com',
      );
      
      // assert
      expect(viewModel.user, equals(updatedUser));
      expect(viewModel.isUpdating, false);
      expect(viewModel.errorMessage, isNull);
      
      verify(mockUpdateUserProfileUseCase.execute(any));
    });
    
    test('should set updating state correctly', () async {
      // arrange
      when(mockUpdateUserProfileUseCase.execute(any))
          .thenAnswer((_) async {
            await Future.delayed(Duration(milliseconds: 100));
            return Right(updatedUser);
          });
      
      // act
      final future = viewModel.updateProfile(
        name: 'Updated Name',
        email: 'updated@example.com',
      );
      
      // assert - during update
      expect(viewModel.isUpdating, true);
      
      await future;
      
      // assert - after update
      expect(viewModel.isUpdating, false);
    });
    
    test('should not update when user is null', () async {
      // arrange
      viewModel.user = null;
      
      // act
      await viewModel.updateProfile(
        name: 'Updated Name',
        email: 'updated@example.com',
      );
      
      // assert
      verifyNever(mockUpdateUserProfileUseCase.execute(any));
      expect(viewModel.isUpdating, false);
    });
    
    test('should handle update error correctly', () async {
      // arrange
      const errorMessage = 'Update failed';
      when(mockUpdateUserProfileUseCase.execute(any))
          .thenAnswer((_) async => Left(ValidationFailure(errorMessage)));
      
      // act
      await viewModel.updateProfile(
        name: 'Updated Name',
        email: 'updated@example.com',
      );
      
      // assert
      expect(viewModel.user, equals(originalUser)); // 使用者未變更
      expect(viewModel.isUpdating, false);
      expect(viewModel.errorMessage, equals(errorMessage));
    });
  });
  
  group('deleteAccount', () {
    final User testUser = TestHelper.createMockUser();
    
    setUp(() {
      viewModel.user = testUser;
    });
    
    test('should delete account successfully', () async {
      // arrange
      when(mockDeleteUserAccountUseCase.execute(testUser.id))
          .thenAnswer((_) async => Right(null));
      
      // act
      final result = await viewModel.deleteAccount();
      
      // assert
      expect(result, true);
      expect(viewModel.user, isNull);
      expect(viewModel.isLoading, false);
      expect(viewModel.errorMessage, isNull);
      
      verify(mockDeleteUserAccountUseCase.execute(testUser.id));
    });
    
    test('should return false when user is null', () async {
      // arrange
      viewModel.user = null;
      
      // act
      final result = await viewModel.deleteAccount();
      
      // assert
      expect(result, false);
      verifyNever(mockDeleteUserAccountUseCase.execute(any));
    });
    
    test('should handle delete error correctly', () async {
      // arrange
      const errorMessage = 'Delete failed';
      when(mockDeleteUserAccountUseCase.execute(testUser.id))
          .thenAnswer((_) async => Left(ServerFailure(errorMessage)));
      
      // act
      final result = await viewModel.deleteAccount();
      
      // assert
      expect(result, false);
      expect(viewModel.user, equals(testUser)); // 使用者仍存在
      expect(viewModel.isLoading, false);
      expect(viewModel.errorMessage, equals(errorMessage));
    });
  });
  
  group('refresh', () {
    final User testUser = TestHelper.createMockUser();
    
    test('should refresh user data when user exists', () async {
      // arrange
      viewModel.user = testUser;
      when(mockGetUserProfileUseCase.execute(testUser.id))
          .thenAnswer((_) async => Right(testUser));
      
      // act
      await viewModel.refresh();
      
      // assert
      verify(mockGetUserProfileUseCase.execute(testUser.id));
    });
    
    test('should not refresh when user is null', () async {
      // arrange
      viewModel.user = null;
      
      // act
      await viewModel.refresh();
      
      // assert
      verifyNever(mockGetUserProfileUseCase.execute(any));
    });
  });
  
  group('clearError', () {
    test('should clear error message', () {
      // arrange
      viewModel.setError('Test error'); // 假設有這個方法
      
      // act
      viewModel.clearError();
      
      // assert
      expect(viewModel.errorMessage, isNull);
    });
  });
}
```

------

## 🖼️ Widget 測試設計

### 基本 Widget 測試

```dart
// 位置: test/widget/pages/user_profile_page_test.dart

import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:provider/provider.dart';
import 'package:mockito/mockito.dart';
import 'package:network_image_mock/network_image_mock.dart';

import '../../helpers/test_helper.dart';
import '../../helpers/test_helper.mocks.dart';

void main() {
  late MockUserViewModel mockViewModel;
  
  setUp(() {
    TestHelper.setUpTestEnvironment();
    mockViewModel = MockUserViewModel();
  });
  
  tearDown(() {
    TestHelper.tearDownTestEnvironment();
  });
  
  group('UserProfilePage Widget Tests', () {
    testWidgets('should display loading indicator when isLoading is true', (WidgetTester tester) async {
      // arrange
      mockViewModel.setMockState(mockIsLoading: true);
      
      // act
      await tester.pumpWidget(
        ChangeNotifierProvider<UserViewModel>.value(
          value: mockViewModel,
          child: TestHelper.wrapWithMaterialApp(
            UserProfilePage(userId: 'test_id'),
          ),
        ),
      );
      
      // assert
      TestHelper.expectWidgetExists(
        find.byType(CircularProgressIndicator),
        reason: 'Loading indicator should be visible',
      );
      TestHelper.expectTextExists('載入使用者資料中...');
    });
    
    testWidgets('should display user profile when user is loaded', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser(
        name: 'John Doe',
        email: 'john@example.com',
      );
      mockViewModel.setMockState(mockUser: testUser);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectTextExists(testUser.displayName);
      TestHelper.expectTextExists(testUser.email);
      TestHelper.expectTextExists('編輯個人資料');
      TestHelper.expectWidgetExists(find.byType(CircleAvatar));
    });
    
    testWidgets('should display error message when error occurs', (WidgetTester tester) async {
      // arrange
      const errorMessage = 'Failed to load user';
      mockViewModel.setMockState(mockError: errorMessage);
      
      // act
      await tester.pumpWidget(
        ChangeNotifierProvider<UserViewModel>.value(
          value: mockViewModel,
          child: TestHelper.wrapWithMaterialApp(
            UserProfilePage(userId: 'test_id'),
          ),
        ),
      );
      
      // assert
      TestHelper.expectTextExists('載入失敗');
      TestHelper.expectTextExists(errorMessage);
      TestHelper.expectTextExists('重新載入');
      TestHelper.expectWidgetExists(find.byIcon(Icons.error_outline));
    });
    
    testWidgets('should call refresh when refresh button is tapped', (WidgetTester tester) async {
      // arrange
      const errorMessage = 'Failed to load user';
      mockViewModel.setMockState(mockError: errorMessage);
      
      // act
      await tester.pumpWidget(
        ChangeNotifierProvider<UserViewModel>.value(
          value: mockViewModel,
          child: TestHelper.wrapWithMaterialApp(
            UserProfilePage(userId: 'test_id'),
          ),
        ),
      );
      
      await TestHelper.tapAndSettle(tester, find.text('重新載入'));
      
      // assert
      verify(mockViewModel.loadUserProfile('test_id')).called(1);
    });
    
    testWidgets('should show error banner when error exists but user is loaded', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      const errorMessage = 'Update failed';
      mockViewModel.setMockState(
        mockUser: testUser,
        mockError: errorMessage,
      );
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectTextExists(errorMessage);
      TestHelper.expectWidgetExists(find.byIcon(Icons.error));
      TestHelper.expectWidgetExists(find.byIcon(Icons.close));
    });
    
    testWidgets('should dismiss error banner when close button is tapped', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      const errorMessage = 'Update failed';
      mockViewModel.setMockState(
        mockUser: testUser,
        mockError: errorMessage,
      );
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      await TestHelper.tapAndSettle(tester, find.byIcon(Icons.close));
      
      // assert
      verify(mockViewModel.clearError()).called(1);
    });
    
    testWidgets('should show correct status chip based on user status', (WidgetTester tester) async {
      // arrange
      final activeUser = TestHelper.createMockUser(status: UserStatus.active);
      mockViewModel.setMockState(mockUser: activeUser);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectTextExists('活躍');
      
      // Test different status
      final inactiveUser = TestHelper.createMockUser(status: UserStatus.inactive);
      mockViewModel.setMockState(mockUser: inactiveUser);
      await tester.pump();
      
      TestHelper.expectTextExists('非活躍');
    });
    
    testWidgets('should navigate to edit profile page when edit button is tapped', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(mockUser: testUser);
      
      final mockNavigatorObserver = MockNavigatorObserver();
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: MaterialApp(
              navigatorObservers: [mockNavigatorObserver],
              home: UserProfilePage(userId: 'test_id'),
              routes: {
                '/edit-profile': (context) => EditProfilePage(user: testUser),
              },
            ),
          ),
        );
      });
      
      await TestHelper.tapAndSettle(tester, find.text('編輯個人資料'));
      
      // assert
      verify(mockNavigatorObserver.didPush(any, any));
    });
    
    testWidgets('should show loading indicator on buttons when isUpdating is true', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(
        mockUser: testUser,
        mockIsUpdating: true,
      );
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectTextExists('更新中...');
      TestHelper.expectWidgetExists(find.byType(CircularProgressIndicator));
    });
    
    testWidgets('should show delete confirmation dialog when delete button is tapped', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(mockUser: testUser);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      await TestHelper.tapAndSettle(tester, find.text('刪除帳號'));
      
      // assert
      TestHelper.expectWidgetExists(find.byType(AlertDialog));
      TestHelper.expectTextExists('刪除帳號');
      TestHelper.expectTextExists('確定要刪除此帳號嗎？此操作無法復原。');
      TestHelper.expectTextExists('取消');
      TestHelper.expectTextExists('刪除');
    });
    
    testWidgets('should call deleteAccount when delete is confirmed', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(mockUser: testUser);
      when(mockViewModel.deleteAccount()).thenAnswer((_) async => true);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      await TestHelper.tapAndSettle(tester, find.text('刪除帳號'));
      await TestHelper.tapAndSettle(tester, find.text('刪除'));
      
      // assert
      verify(mockViewModel.deleteAccount()).called(1);
    });
  });
  
  group('UserProfilePage Responsive Tests', () {
    testWidgets('should adapt layout for different screen sizes', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(mockUser: testUser);
      
      // act - Mobile screen
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMediaQuery(
            ChangeNotifierProvider<UserViewModel>.value(
              value: mockViewModel,
              child: TestHelper.wrapWithMaterialApp(
                UserProfilePage(userId: 'test_id'),
              ),
            ),
            width: 375, // Mobile width
            height: 812,
          ),
        );
      });
      
      // assert - Mobile layout
      TestHelper.expectWidgetExists(find.byType(Column));
      
      // act - Tablet screen
      await tester.pumpWidget(
        TestHelper.wrapWithMediaQuery(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
          width: 768, // Tablet width
          height: 1024,
        ),
      );
      
      await tester.pump();
      
      // assert - Layout should still work on tablet
      TestHelper.expectWidgetExists(find.byType(UserProfilePage));
    });
    
    testWidgets('should handle dark theme correctly', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(mockUser: testUser);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMediaQuery(
            ChangeNotifierProvider<UserViewModel>.value(
              value: mockViewModel,
              child: MaterialApp(
                theme: ThemeData.light(),
                darkTheme: ThemeData.dark(),
                themeMode: ThemeMode.dark,
                home: UserProfilePage(userId: 'test_id'),
              ),
            ),
            platformBrightness: Brightness.dark,
          ),
        );
      });
      
      // assert
      final materialApp = tester.widget<MaterialApp>(find.byType(MaterialApp));
      expect(materialApp.darkTheme, isNotNull);
    });
  });
  
  group('UserProfilePage Accessibility Tests', () {
    testWidgets('should have proper accessibility labels', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(mockUser: testUser);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectWidgetExists(find.byType(Semantics));
      
      // 檢查重要按鈕是否有適當的語義標籤
      final editButton = find.text('編輯個人資料');
      expect(editButton, findsOneWidget);
      
      final deleteButton = find.text('刪除帳號');
      expect(deleteButton, findsOneWidget);
    });
    
    testWidgets('should be navigable with keyboard', (WidgetTester tester) async {
      // arrange
      final testUser = TestHelper.createMockUser();
      mockViewModel.setMockState(mockUser: testUser);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          ChangeNotifierProvider<UserViewModel>.value(
            value: mockViewModel,
            child: TestHelper.wrapWithMaterialApp(
              UserProfilePage(userId: 'test_id'),
            ),
          ),
        );
      });
      
      // 模擬 Tab 鍵導航
      await tester.sendKeyEvent(LogicalKeyboardKey.tab);
      await tester.pump();
      
      // assert
      // 確保焦點可以在可交互元素之間移動
      TestHelper.expectWidgetExists(find.byType(Focus));
    });
  });
}

// Mock Navigator Observer
class MockNavigatorObserver extends Mock implements NavigatorObserver {}
```

### 複雜 Widget 測試

```dart
// 位置: test/widget/widgets/user_list_widget_test.dart

import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';

import '../../helpers/test_helper.dart';

void main() {
  group('UserListWidget Tests', () {
    testWidgets('should display list of users', (WidgetTester tester) async {
      // arrange
      final users = TestHelper.createMockUserList(5);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            UserListWidget(
              users: users,
              onUserTap: (user) {},
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectWidgetCount(find.byType(ListTile), 5);
      
      for (final user in users) {
        TestHelper.expectTextExists(user.name);
        TestHelper.expectTextExists(user.email);
      }
    });
    
    testWidgets('should handle empty user list', (WidgetTester tester) async {
      // act
      await tester.pumpWidget(
        TestHelper.wrapWithMaterialApp(
          UserListWidget(
            users: [],
            onUserTap: (user) {},
          ),
        ),
      );
      
      // assert
      TestHelper.expectTextExists('沒有使用者資料');
      TestHelper.expectWidgetExists(find.byIcon(Icons.person_outline));
    });
    
    testWidgets('should call onUserTap when user is tapped', (WidgetTester tester) async {
      // arrange
      final users = TestHelper.createMockUserList(3);
      User? tappedUser;
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            UserListWidget(
              users: users,
              onUserTap: (user) => tappedUser = user,
            ),
          ),
        );
      });
      
      await TestHelper.tapAndSettle(tester, find.text(users[1].name));
      
      // assert
      expect(tappedUser, equals(users[1]));
    });
    
    testWidgets('should support pull to refresh', (WidgetTester tester) async {
      // arrange
      final users = TestHelper.createMockUserList(3);
      bool refreshCalled = false;
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            RefreshIndicator(
              onRefresh: () async {
                refreshCalled = true;
              },
              child: UserListWidget(
                users: users,
                onUserTap: (user) {},
              ),
            ),
          ),
        );
      });
      
      // 模擬下拉刷新
      await tester.fling(
        find.byType(ListView),
        const Offset(0, 300),
        1000,
      );
      await TestHelper.pumpAndSettle(tester);
      
      // assert
      expect(refreshCalled, true);
    });
    
    testWidgets('should handle scroll to load more', (WidgetTester tester) async {
      // arrange
      final users = TestHelper.createMockUserList(20);
      bool loadMoreCalled = false;
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            UserListWidget(
              users: users,
              onUserTap: (user) {},
              onLoadMore: () => loadMoreCalled = true,
            ),
          ),
        );
      });
      
      // 滾動到底部
      await tester.scrollUntilVisible(
        find.text(users.last.name),
        500.0,
      );
      await TestHelper.pumpAndSettle(tester);
      
      // assert
      expect(loadMoreCalled, true);
    });
    
    testWidgets('should show loading indicator when loading more', (WidgetTester tester) async {
      // arrange
      final users = TestHelper.createMockUserList(10);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            UserListWidget(
              users: users,
              onUserTap: (user) {},
              isLoadingMore: true,
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectWidgetExists(find.byType(CircularProgressIndicator));
    });
    
    testWidgets('should filter users based on search query', (WidgetTester tester) async {
      // arrange
      final users = [
        TestHelper.createMockUser(name: 'John Doe', email: 'john@example.com'),
        TestHelper.createMockUser(name: 'Jane Smith', email: 'jane@example.com'),
        TestHelper.createMockUser(name: 'Bob Johnson', email: 'bob@example.com'),
      ];
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            Column(
              children: [
                TextField(
                  key: Key('search_field'),
                  onChanged: (query) {
                    // 這裡應該觸發搜尋邏輯
                  },
                ),
                Expanded(
                  child: UserListWidget(
                    users: users.where((user) =>
                        user.name.toLowerCase().contains('john')).toList(),
                    onUserTap: (user) {},
                  ),
                ),
              ],
            ),
          ),
        );
      });
      
      // assert
      TestHelper.expectTextExists('John Doe');
      TestHelper.expectTextExists('Bob Johnson');
      TestHelper.expectWidgetNotExists(find.text('Jane Smith'));
    });
  });
  
  group('UserListWidget Performance Tests', () {
    testWidgets('should handle large list efficiently', (WidgetTester tester) async {
      // arrange
      final largeUserList = TestHelper.createMockUserList(1000);
      
      // act
      final stopwatch = Stopwatch()..start();
      
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            UserListWidget(
              users: largeUserList,
              onUserTap: (user) {},
            ),
          ),
        );
      });
      
      stopwatch.stop();
      
      // assert
      expect(stopwatch.elapsedMilliseconds, lessThan(1000)); // 應該在 1 秒內完成
      
      // 確保只渲染可見的項目（ListView.builder 的優勢）
      final listTiles = tester.widgetList(find.byType(ListTile));
      expect(listTiles.length, lessThan(20)); // 屏幕上不應該有太多 ListTile
    });
    
    testWidgets('should recycle list items efficiently', (WidgetTester tester) async {
      // arrange
      final users = TestHelper.createMockUserList(100);
      
      // act
      await TestHelper.mockNetworkImages(() async {
        await tester.pumpWidget(
          TestHelper.wrapWithMaterialApp(
            UserListWidget(
              users: users,
              onUserTap: (user) {},
            ),
          ),
        );
      });
      
      // 記錄初始的 ListTile 數量
      final initialTileCount = tester.widgetList(find.byType(ListTile)).length;
      
      // 滾動列表
      await tester.drag(find.byType(ListView), const Offset(0, -2000));
      await tester.pump();
      
      // 再次檢查 ListTile 數量
      final afterScrollTileCount = tester.widgetList(find.byType(ListTile)).length;
      
      // assert
      // ListView.builder 應該回收不可見的項目
      expect(afterScrollTileCount, lessThanOrEqualTo(initialTileCount + 5));
    });
  });
}
```

------

## 🔗 Integration 測試設計

### 完整流程測試

```dart
// 位置: test/integration/user_flow_test.dart

import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';

import '../helpers/test_helper.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();
  
  group('User Profile Flow Integration Tests', () {
    testWidgets('complete user authentication and profile management flow', (WidgetTester tester) async {
      // 啟動應用程式
      await tester.pumpWidget(MyApp());
      await TestHelper.pumpAndSettle(tester);
      
      // 步驟 1: 使用者登入
      await _performLogin(tester);
      
      // 步驟 2: 導航到個人資料頁面
      await _navigateToProfile(tester);
      
      // 步驟 3: 查看個人資料
      await _viewProfile(tester);
      
      // 步驟 4: 編輯個人資料
      await _editProfile(tester);
      
      // 步驟 5: 驗證更新
      await _verifyProfileUpdate(tester);
      
      // 步驟 6: 測試錯誤處理
      await _testErrorHandling(tester);
    });
    
    testWidgets('offline functionality test', (WidgetTester tester) async {
      // 啟動應用程式
      await tester.pumpWidget(MyApp());
      await TestHelper.pumpAndSettle(tester);
      
      // 模擬離線狀態
      await _simulateOfflineMode(tester);
      
      // 測試離線功能
      await _testOfflineFunctionality(tester);
      
      // 恢復線上狀態
      await _simulateOnlineMode(tester);
      
      // 測試數據同步
      await _testDataSynchronization(tester);
    });
    
    testWidgets('error recovery flow test', (WidgetTester tester) async {
      // 啟動應用程式
      await tester.pumpWidget(MyApp());
      await TestHelper.pumpAndSettle(tester);
      
      // 模擬各種錯誤情況
      await _testNetworkError(tester);
      await _testValidationError(tester);
      await _testServerError(tester);
      
      // 測試錯誤恢復
      await _testErrorRecovery(tester);
    });
  });
  
  group('Performance Integration Tests', () {
    testWidgets('app startup performance test', (WidgetTester tester) async {
      final stopwatch = Stopwatch()..start();
      
      // 啟動應用程式
      await tester.pumpWidget(MyApp());
      await TestHelper.pumpAndSettle(tester);
      
      stopwatch.stop();
      
      // 驗證啟動時間
      expect(stopwatch.elapsedMilliseconds, lessThan(3000)); // 3 秒內啟動
      
      // 驗證首頁載入
      TestHelper.expectWidgetExists(find.byType(HomePage));
    });
    
    testWidgets('memory usage test', (WidgetTester tester) async {
      // 啟動應用程式
      await tester.pumpWidget(MyApp());
      await TestHelper.pumpAndSettle(tester);
      
      // 執行記憶體密集型操作
      await _performMemoryIntensiveOperations(tester);
      
      // 檢查記憶體使用情況
      // 這裡可以添加記憶體使用量檢查邏輯
    });
  });
}

// 輔助方法
Future<void> _performLogin(WidgetTester tester) async {
  // 尋找登入按鈕
  final loginButton = find.text('登入');
  if (loginButton.evaluate().isEmpty) {
    // 如果沒有登入按鈕，可能已經登入
    return;
  }
  
  // 點擊登入按鈕
  await TestHelper.tapAndSettle(tester, loginButton);
  
  // 輸入使用者名稱
  await TestHelper.enterTextAndSettle(
    tester,
    find.byKey(Key('username_field')),
    'test@example.com',
  );
  
  // 輸入密碼
  await TestHelper.enterTextAndSettle(
    tester,
    find.byKey(Key('password_field')),
    'password123',
  );
  
  // 提交登入表單
  await TestHelper.tapAndSettle(tester, find.text('登入'));
  
  // 等待登入完成
  await TestHelper.pumpAndSettle(tester);
  
  // 驗證登入成功
  TestHelper.expectWidgetExists(find.byType(HomePage));
}

Future<void> _navigateToProfile(WidgetTester tester) async {
  // 點擊個人資料選項卡或按鈕
  await TestHelper.tapAndSettle(tester, find.byIcon(Icons.person));
  
  // 驗證導航成功
  TestHelper.expectWidgetExists(find.byType(UserProfilePage));
}

Future<void> _viewProfile(WidgetTester tester) async {
  // 等待個人資料載入
  await TestHelper.pumpAndSettle(tester);
  
  // 驗證個人資料顯示
  TestHelper.expectWidgetExists(find.byType(CircleAvatar));
  TestHelper.expectWidgetExists(find.textContaining('@')); // 電子郵件
  TestHelper.expectTextExists('編輯個人資料');
}

Future<void> _editProfile(WidgetTester tester) async {
  // 點擊編輯按鈕
  await TestHelper.tapAndSettle(tester, find.text('編輯個人資料'));
  
  // 驗證編輯頁面開啟
  TestHelper.expectWidgetExists(find.byType(EditProfilePage));
  
  // 修改使用者名稱
  final nameField = find.byKey(Key('name_field'));
  await tester.clear(nameField);
  await TestHelper.enterTextAndSettle(tester, nameField, 'Updated Name');
  
  // 修改電子郵件
  final emailField = find.byKey(Key('email_field'));
  await tester.clear(emailField);
  await TestHelper.enterTextAndSettle(tester, emailField, 'updated@example.com');
  
  // 保存變更
  await TestHelper.tapAndSettle(tester, find.text('保存'));
  
  // 等待保存完成
  await TestHelper.pumpAndSettle(tester);
}

```